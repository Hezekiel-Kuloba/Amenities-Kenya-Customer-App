The supplier app, should only have the log in page, it should take the email and password, then the verify otp screen
As these will be provided by the admin app, the json of the supplier should have something like this

email
password
amenity_type, either gas, clean_water, drinking_water, garbage_disposal, sewage_collection

When the supplier logs in he should be able to see the category amenity he applied to eg gas supplier etc,
He should see his product catalog,
He should be able to add, delete, customize, his product catalog for all the specific amenity field he specializes in,
The supplier should be able to set his location which will be seen in the user app, 
He should be able to set the following also, the delivery fee per kilometer, basically all the details in the user app, that are for the supplier to set, eg promotions,
The supplier should be able to receive orders, process orders, process payments, rate user order, process order tracking etc.

Now ill give you all the code for the user app, and i would like you to write from the above instructions and from the code of the user app, the journeys of the supplier from login to rating the user order, from customizing his product catalog

import 'package:amenities_kenya/models/supplier.dart';
import 'package:uuid/uuid.dart';


class Order {
  final String orderId;
  final String userId;
  final String supplierId;
  final String category;
  final OrderDetails details;
  final DeliveryAddress deliveryAddress;
  final Schedule schedule;
  final String instructions;
  final String status;
  final DateTime createdAt;
  final DateTime? estimatedDeliveryTime;
  final String? paymentMethod;
  final bool isRecurring;


  Order({
    String? orderId,
    required this.userId,
    required this.supplierId,
    required this.category,
    required this.details,
    required this.deliveryAddress,
    required this.schedule,
    required this.instructions,
    required this.status,
    required this.createdAt,
    this.estimatedDeliveryTime,
    this.paymentMethod,
    this.isRecurring = false,
  }) : orderId = orderId ?? const Uuid().v4();


  factory Order.fromJson(Map<String, dynamic> json) {
    return Order(
      orderId: json['order_id'],
      userId: json['user_id'],
      supplierId: json['supplier_id'],
      category: json['category'],
      details: OrderDetails.fromJson(json['details'], json['category']),
      deliveryAddress: DeliveryAddress.fromJson(json['delivery_address']),
      schedule: Schedule.fromJson(json['schedule']),
      instructions: json['instructions'],
      status: json['status'],
      createdAt: DateTime.parse(json['created_at']),
      estimatedDeliveryTime: json['estimated_delivery_time'] != null
          ? DateTime.parse(json['estimated_delivery_time'])
          : null,
      paymentMethod: json['payment_method'] as String?,
      isRecurring: json['is_recurring'] as bool? ?? false,
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'order_id': orderId,
      'user_id': userId,
      'supplier_id': supplierId,
      'category': category,
      'details': details.toJson(category),
      'delivery_address': deliveryAddress.toJson(),
      'schedule': schedule.toJson(),
      'instructions': instructions,
      'status': status,
      'created_at': createdAt.toIso8601String(),
      'estimated_delivery_time': estimatedDeliveryTime?.toIso8601String(),
      'payment_method': paymentMethod,
      'is_recurring': isRecurring,
    };
  }


  Order copyWith({
    String? orderId,
    String? userId,
    String? supplierId,
    String? category,
    OrderDetails? details,
    DeliveryAddress? deliveryAddress,
    Schedule? schedule,
    String? instructions,
    String? status,
    DateTime? createdAt,
    DateTime? estimatedDeliveryTime,
    String? paymentMethod,
    bool? isRecurring,
  }) {
    return Order(
      orderId: orderId ?? this.orderId,
      userId: userId ?? this.userId,
      supplierId: supplierId ?? this.supplierId,
      category: category ?? this.category,
      details: details ?? this.details,
      deliveryAddress: deliveryAddress ?? this.deliveryAddress,
      schedule: schedule ?? this.schedule,
      instructions: instructions ?? this.instructions,
      status: status ?? this.status,
      createdAt: createdAt ?? this.createdAt,
      estimatedDeliveryTime: estimatedDeliveryTime ?? this.estimatedDeliveryTime,
      paymentMethod: paymentMethod ?? this.paymentMethod,
      isRecurring: isRecurring ?? this.isRecurring,
    );
  }
}


class OrderDetails {
  final double? liters;
  final double? pricePerLiter;
  final OrderItem? item;
  final String? type;
  final int? bags;
  final double? basePrice;
  final double? additionalBagPrice;
  final int? additionalBags;
  final double? pricePerBag;
  final int? trips;
  final double? pricePerTrip;
  final double deliveryFee;
  final double totalCost;


  OrderDetails({
    this.liters,
    this.pricePerLiter,
    this.item,
    this.type,
    this.bags,
    this.basePrice,
    this.additionalBagPrice,
    this.additionalBags,
    this.pricePerBag,
    this.trips,
    this.pricePerTrip,
    required this.deliveryFee,
    required this.totalCost,
  });


  factory OrderDetails.fromJson(Map<String, dynamic> json, String category) {
    switch (category) {
      case 'Clean Water Services':
        return OrderDetails(
          liters: (json['liters'] as num?)?.toDouble(),
          pricePerLiter: (json['price_per_liter'] as num?)?.toDouble(),
          deliveryFee: (json['delivery_fee'] as num).toDouble(),
          totalCost: (json['total_cost'] as num).toDouble(),
        );
      case 'Gas Supply and Refill':
      case 'Drinking Water':
        return OrderDetails(
          item: json['item'] != null ? OrderItem.fromJson(json['item']) : null,
          deliveryFee: (json['delivery_fee'] as num).toDouble(),
          totalCost: (json['total_cost'] as num).toDouble(),
        );
      case 'Garbage Disposal':
        return OrderDetails(
          type: json['type'],
          bags: json['bags'],
          basePrice: (json['base_price'] as num?)?.toDouble(),
          additionalBagPrice: (json['additional_bag_price'] as num?)?.toDouble(),
          additionalBags: json['additional_bags'],
          pricePerBag: (json['price_per_bag'] as num?)?.toDouble(),
          deliveryFee: (json['delivery_fee'] as num).toDouble(),
          totalCost: (json['total_cost'] as num).toDouble(),
        );
      case 'Toilet/Latrine/Septic Tank Emptying':
        return OrderDetails(
          trips: json['trips'],
          pricePerTrip: (json['price_per_trip'] as num?)?.toDouble(),
          deliveryFee: (json['delivery_fee'] as num).toDouble(),
          totalCost: (json['total_cost'] as num).toDouble(),
        );
      default:
        return OrderDetails(
          deliveryFee: (json['delivery_fee'] as num).toDouble(),
          totalCost: (json['total_cost'] as num).toDouble(),
        );
    }
  }


  Map<String, dynamic> toJson(String category) {
    final json = <String, dynamic>{
      'delivery_fee': deliveryFee,
      'total_cost': totalCost,
    };
    if (liters != null) json['liters'] = liters;
    if (pricePerLiter != null) json['price_per_liter'] = pricePerLiter;
    if (item != null) json['item'] = item!.toJson();
    if (type != null) json['type'] = type;
    if (bags != null) json['bags'] = bags;
    if (basePrice != null) json['base_price'] = basePrice;
    if (additionalBagPrice != null) json['additional_bag_price'] = additionalBagPrice;
    if (additionalBags != null) json['additional_bags'] = additionalBags;
    if (pricePerBag != null) json['price_per_bag'] = pricePerBag;
    if (trips != null) json['trips'] = trips;
    if (pricePerTrip != null) json['price_per_trip'] = pricePerTrip;
    return json;
  }
}


class OrderItem {
  final String type;
  final String? brand;
  final String? size;
  final int quantity;
  final double price;
  final String? name;


  OrderItem({
    required this.type,
    this.brand,
    this.size,
    required this.quantity,
    required this.price,
    this.name,
  });


  factory OrderItem.fromJson(Map<String, dynamic> json) {
    return OrderItem(
      type: json['type'],
      brand: json['brand'],
      size: json['size'],
      quantity: json['quantity'],
      price: (json['price'] as num).toDouble(),
      name: json['name'],
    );
  }


  Map<String, dynamic> toJson() {
    final json = <String, dynamic>{
      'type': type,
      'quantity': quantity,
      'price': price,
    };
    if (brand != null) json['brand'] = brand;
    if (size != null) json['size'] = size;
    if (name != null) json['name'] = name;
    return json;
  }
}


class DeliveryAddress {
  final String address;
  final Coordinates coordinates;


  DeliveryAddress({required this.address, required this.coordinates});


  factory DeliveryAddress.fromJson(Map<String, dynamic> json) {
    return DeliveryAddress(
      address: json['address'],
      coordinates: Coordinates.fromJson(json['coordinates']),
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'address': address,
      'coordinates': coordinates.toJson(),
    };
  }
}


class Schedule {
  final String type;
  final String? dateTime;
  final String? day;
  final String? time;
  final int? dayOfMonth;


  Schedule({
    required this.type,
    this.dateTime,
    this.day,
    this.time,
    this.dayOfMonth,
  });


  factory Schedule.fromJson(Map<String, dynamic> json) {
    return Schedule(
      type: json['type'],
      dateTime: json['date_time'],
      day: json['day'],
      time: json['time'],
      dayOfMonth: json['day_of_month'],
    );
  }


  Map<String, dynamic> toJson() {
    final json = <String, dynamic>{'type': type};
    if (dateTime != null) json['date_time'] = dateTime;
    if (day != null) json['day'] = day;
    if (time != null) json['time'] = time;
    if (dayOfMonth != null) json['day_of_month'] = dayOfMonth;
    return json;
  }
}
class Supplier {
  final String supplierId;
  final String name;
  final String category;
  final String address;
  final Coordinates coordinates;
  final String contactPhone;
  final String imageUrl;
  final double averageRating;
  final int reviewCount;
  final Pricing pricing;
  final List<Promotion> promotions;
  final Availability availability;
  final DateTime createdAt;


  Supplier({
    required this.supplierId,
    required this.name,
    required this.category,
    required this.address,
    required this.coordinates,
    required this.contactPhone,
    required this.imageUrl,
    required this.averageRating,
    required this.reviewCount,
    required this.pricing,
    required this.promotions,
    required this.availability,
    required this.createdAt,
  });


  factory Supplier.fromJson(Map<String, dynamic> json) {
    return Supplier(
      supplierId: json['supplier_id'],
      name: json['name'],
      category: json['category'],
      address: json['address'],
      coordinates: Coordinates.fromJson(json['coordinates']),
      contactPhone: json['contact_phone'],
      imageUrl: json['image_url'],
      averageRating: (json['average_rating'] as num).toDouble(),
      reviewCount: json['review_count'],
      pricing: Pricing.fromJson(json['pricing'], json['category']),
      promotions: (json['promotions'] as List)
          .map((promo) => Promotion.fromJson(promo))
          .toList(),
      availability: Availability.fromJson(json['availability']),
      createdAt: DateTime.parse(json['created_at']),
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'supplier_id': supplierId,
      'name': name,
      'category': category,
      'address': address,
      'coordinates': coordinates.toJson(),
      'contact_phone': contactPhone,
      'image_url': imageUrl,
      'average_rating': averageRating,
      'review_count': reviewCount,
      'pricing': pricing.toJson(category),
      'promotions': promotions.map((promo) => promo.toJson()).toList(),
      'availability': availability.toJson(),
      'created_at': createdAt.toIso8601String(),
    };
  }
}


class Coordinates {
  final double lat;
  final double lon;


  Coordinates({required this.lat, required this.lon});


  factory Coordinates.fromJson(Map<String, dynamic> json) {
    return Coordinates(
      lat: (json['lat'] as num).toDouble(),
      lon: (json['lon'] as num).toDouble(),
    );
  }


  Map<String, dynamic> toJson() {
    return {'lat': lat, 'lon': lon};
  }
}


class Pricing {
  final double? pricePerLiter;
  final double? deliveryFeePerKm;
  final List<Cylinder>? cylinders;
  final List<Accessory>? accessories;
  final List<Bottle>? bottles;
  final CollectionPricing? collection;
  final BagsOnlyPricing? bagsOnly;
  final double? pricePerTrip;


  Pricing({
    this.pricePerLiter,
    this.deliveryFeePerKm,
    this.cylinders,
    this.accessories,
    this.bottles,
    this.collection,
    this.bagsOnly,
    this.pricePerTrip,
  });


  factory Pricing.fromJson(Map<String, dynamic> json, String category) {
    switch (category) {
      case 'Clean Water Services':
        return Pricing(
          pricePerLiter: (json['price_per_liter'] as num?)?.toDouble(),
          deliveryFeePerKm: (json['delivery_fee_per_km'] as num?)?.toDouble(),
        );
      case 'Gas Supply and Refill':
        return Pricing(
          cylinders: (json['cylinders'] as List?)
              ?.map((c) => Cylinder.fromJson(c))
              .toList(),
          accessories: (json['accessories'] as List?)
              ?.map((a) => Accessory.fromJson(a))
              .toList(),
          deliveryFeePerKm: (json['delivery_fee_per_km'] as num?)?.toDouble(),
        );
      case 'Drinking Water':
        return Pricing(
          bottles: (json['bottles'] as List?)
              ?.map((b) => Bottle.fromJson(b))
              .toList(),
          deliveryFeePerKm: (json['delivery_fee_per_km'] as num?)?.toDouble(),
        );
      case 'Garbage Disposal':
        return Pricing(
          collection: json['collection'] != null
              ? CollectionPricing.fromJson(json['collection'])
              : null,
          bagsOnly: json['bags_only'] != null
              ? BagsOnlyPricing.fromJson(json['bags_only'])
              : null,
          deliveryFeePerKm: (json['delivery_fee_per_km'] as num?)?.toDouble(),
        );
      case 'Toilet/Latrine/Septic Tank Emptying':
        return Pricing(
          pricePerTrip: (json['price_per_trip'] as num?)?.toDouble(),
          deliveryFeePerKm: (json['delivery_fee_per_km'] as num?)?.toDouble(),
        );
      default:
        return Pricing();
    }
  }


  Map<String, dynamic> toJson(String category) {
    final json = <String, dynamic>{};
    if (pricePerLiter != null) json['price_per_liter'] = pricePerLiter;
    if (deliveryFeePerKm != null) json['delivery_fee_per_km'] = deliveryFeePerKm;
    if (cylinders != null) {
      json['cylinders'] = cylinders!.map((c) => c.toJson()).toList();
    }
    if (accessories != null) {
      json['accessories'] = accessories!.map((a) => a.toJson()).toList();
    }
    if (bottles != null) {
      json['bottles'] = bottles!.map((b) => b.toJson()).toList();
    }
    if (collection != null) json['collection'] = collection!.toJson();
    if (bagsOnly != null) json['bags_only'] = bagsOnly!.toJson();
    if (pricePerTrip != null) json['price_per_trip'] = pricePerTrip;
    return json;
  }
}


class Cylinder {
  final String brand;
  final String size;
  final double newPrice;
  final double refillPrice;


  Cylinder({
    required this.brand,
    required this.size,
    required this.newPrice,
    required this.refillPrice,
  });


  factory Cylinder.fromJson(Map<String, dynamic> json) {
    return Cylinder(
      brand: json['brand'],
      size: json['size'],
      newPrice: (json['new_price'] as num).toDouble(),
      refillPrice: (json['refill_price'] as num).toDouble(),
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'brand': brand,
      'size': size,
      'new_price': newPrice,
      'refill_price': refillPrice,
    };
  }
}


class Accessory {
  final String name;
  final double price;


  Accessory({required this.name, required this.price});


  factory Accessory.fromJson(Map<String, dynamic> json) {
    return Accessory(
      name: json['name'],
      price: (json['price'] as num).toDouble(),
    );
  }


  Map<String, dynamic> toJson() {
    return {'name': name, 'price': price};
  }
}


class Bottle {
  final String size;
  final double newPrice;
  final double refillPrice;


  Bottle({
    required this.size,
    required this.newPrice,
    required this.refillPrice,
  });


  factory Bottle.fromJson(Map<String, dynamic> json) {
    return Bottle(
      size: json['size'],
      newPrice: (json['new_price'] as num).toDouble(),
      refillPrice: (json['refill_price'] as num).toDouble(),
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'size': size,
      'new_price': newPrice,
      'refill_price': refillPrice,
    };
  }
}


class CollectionPricing {
  final double basePrice;
  final int bagsIncluded;
  final double additionalBagPrice;


  CollectionPricing({
    required this.basePrice,
    required this.bagsIncluded,
    required this.additionalBagPrice,
  });


  factory CollectionPricing.fromJson(Map<String, dynamic> json) {
    return CollectionPricing(
      basePrice: (json['base_price'] as num).toDouble(),
      bagsIncluded: json['bags_included'],
      additionalBagPrice: (json['additional_bag_price'] as num).toDouble(),
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'base_price': basePrice,
      'bags_included': bagsIncluded,
      'additional_bag_price': additionalBagPrice,
    };
  }
}


class BagsOnlyPricing {
  final double pricePerBag;


  BagsOnlyPricing({required this.pricePerBag});


  factory BagsOnlyPricing.fromJson(Map<String, dynamic> json) {
    return BagsOnlyPricing(
      pricePerBag: (json['price_per_bag'] as num).toDouble(),
    );
  }


  Map<String, dynamic> toJson() {
    return {'price_per_bag': pricePerBag};
  }
}


class Promotion {
  final String description;
  final String validUntil;


  Promotion({required this.description, required this.validUntil});


  factory Promotion.fromJson(Map<String, dynamic> json) {
    return Promotion(
      description: json['description'],
      validUntil: json['valid_until'],
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'description': description,
      'valid_until': validUntil,
    };
  }
}


class Availability {
  final List<String> days;
  final String hours;


  Availability({required this.days, required this.hours});


  factory Availability.fromJson(Map<String, dynamic> json) {
    return Availability(
      days: List<String>.from(json['days']),
      hours: json['hours'],
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'days': days,
      'hours': hours,
    };
  }
}
class User {
  final String userId;
  final String phoneNumber;
  final String firstName;
  final String lastName;
  final String email;
  final String username;
  final bool emailVerified;
  final DateTime createdAt;
  final String? token;
  final String? otp;


  bool get isLoggedIn => token != null && token!.isNotEmpty;


  User({
    required this.userId,
    required this.phoneNumber,
    required this.firstName,
    required this.lastName,
    required this.email,
    required this.username,
    required this.emailVerified,
    required this.createdAt,
    this.token,
    this.otp,
  });


  factory User.fromJson(Map<String, dynamic> json) {
    return User(
      userId: json['user_id'] ?? '',
      phoneNumber: json['phone_number'] ?? '',
      firstName: json['first_name'] ?? '',
      lastName: json['last_name'] ?? '',
      email: json['email'] ?? '',
      username: json['username'] ?? '',
      emailVerified: json['email_verified'] ?? false,
      createdAt: json['created_at'] != null ? DateTime.parse(json['created_at']) : DateTime.now(),
      token: json['token'],
      otp: json['otp'],
    );
  }


  Map<String, dynamic> toJson() {
    return {
      'user_id': userId,
      'phone_number': phoneNumber,
      'first_name': firstName,
      'last_name': lastName,
      'email': email,
      'username': username,
      'email_verified': emailVerified,
      'created_at': createdAt.toIso8601String(),
      'token': token,
      'otp': otp,
    };
  }
}
import 'dart:convert';
import 'package:amenities_kenya/models/user.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:amenities_kenya/services/mock_auth_service.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:uuid/uuid.dart';


final userProvider = StateNotifierProvider<UserNotifier, User?>((ref) {
  return UserNotifier();
});


class UserNotifier extends StateNotifier<User?> {
  UserNotifier() : super(null) {
    checkLoginStatus();
  }


  final MockAuthService _authService = MockAuthService();


  Future<String> sendOtp(String phoneNumber) async {
    try {
      return await _authService.sendOtp(phoneNumber);
    } catch (e) {
      rethrow;
    }
  }


  Future<void> verifyOtp(String phoneNumber, String otp) async {
    try {
      final user = await _authService.verifyOtp(phoneNumber, otp);
      state = user;
      await _saveToken(user.token!);
    } catch (e) {
      rethrow;
    }
  }


  Future<void> signUp({
    required String userId,
    required String phoneNumber,
    required String firstName,
    required String lastName,
    required String email,
    required String username,
  }) async {
    try {
      final user = await _authService.signUp(
        userId: userId,
        phoneNumber: phoneNumber,
        firstName: firstName,
        lastName: lastName,
        email: email,
        username: username,
      );
      state = user;
    } catch (e) {
      rethrow;
    }
  }


  Future<void> updateProfile({
    required String firstName,
    required String lastName,
    required String email,
    required String phoneNumber,
  }) async {
    if (state == null) throw 'No user logged in';
    try {
      await _authService.updateProfile(
        userId: state!.userId,
        firstName: firstName,
        lastName: lastName,
        email: email,
        phoneNumber: phoneNumber,
      );
      state = User(
        userId: state!.userId,
        phoneNumber: phoneNumber,
        firstName: firstName,
        lastName: lastName,
        email: email,
        username: state!.username,
        emailVerified: state!.emailVerified,
        createdAt: state!.createdAt,
        token: state!.token,
      );
    } catch (e) {
      rethrow;
    }
  }


  Future<void> verifyEmail(String verificationToken) async {
    if (state == null) throw 'No user logged in';
    try {
      await _authService.verifyEmail(state!.userId, verificationToken);
      state = User(
        userId: state!.userId,
        phoneNumber: state!.phoneNumber,
        firstName: state!.firstName,
        lastName: state!.lastName,
        email: state!.email,
        username: state!.username,
        emailVerified: true,
        createdAt: state!.createdAt,
        token: state!.token,
      );
    } catch (e) {
      rethrow;
    }
  }


  Future<void> logout() async {
    if (state == null) return;
    try {
      await _authService.logout(state!.userId);
      await _clearToken();
      state = null;
    } catch (e) {
      rethrow;
    }
  }


  Future<void> _saveToken(String token) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('token', token);
    await prefs.setString('device_id', const Uuid().v4()); // Simulate device ID
  }


  Future<void> _clearToken() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove('token');
    await prefs.remove('device_id');
  }


  Future<bool> checkLoginStatus() async {
    final prefs = await SharedPreferences.getInstance();
    final token = prefs.getString('token');
    final deviceId = prefs.getString('device_id');
   
    if (token != null && token.isNotEmpty) {
      final db = await _loadDb();
      final sessions = db['sessions'] as List<dynamic>;
      final session = sessions.firstWhere(
        (session) =>
            session['token'] == token &&
            session['is_active'] &&
            DateTime.parse(session['expires_at']).isAfter(DateTime.now()),
        orElse: () => null,
      );
     
      if (session != null) {
        final users = db['users'] as List<dynamic>;
        final user = users.firstWhere(
          (user) => user['user_id'] == session['user_id'],
          orElse: () => null,
        );
        if (user != null) {
          // Simulate suspicious activity check
          // In a real app, compare device_id with backend
          state = User.fromJson({
            ...user,
            'token': token,
          });
          return true;
        }
      }
      await _clearToken(); // Clear invalid or expired session
    }
    return false;
  }


  Future<Map<String, dynamic>> _loadDb() async {
    final String jsonString = await rootBundle.loadString('assets/data/db.json');
    return json.decode(jsonString);
  }
}
import 'package:amenities_kenya/services/preferences_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:shared_preferences/shared_preferences.dart';


final localeProvider =
    StateNotifierProvider<LocaleNotifier, Locale>((ref) {
  return LocaleNotifier(ref.read(preferencesServiceProvider));
});


class LocaleNotifier extends StateNotifier<Locale> {
  final PreferencesService _preferencesService;


  LocaleNotifier(this._preferencesService)
      : super(const Locale('en')) {
    _loadLocale();
  }


  Future<void> _loadLocale() async {
    final languageCode =
        await _preferencesService.getLanguageCode() ?? 'en';
    state = Locale(languageCode);
  }


  Future<void> setLocale(Locale locale) async {
    state = locale;
    await _preferencesService.setLanguageCode(locale.languageCode);
  }
}


extension PreferencesServiceLocale on PreferencesService {
  static const _languageCodeKey = 'language_code';


  Future<String?> getLanguageCode() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString(_languageCodeKey);
  }


  Future<void> setLanguageCode(String languageCode) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_languageCodeKey, languageCode);
  }
}
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/services/location_service.dart';


final locationProvider =
    StateNotifierProvider<LocationNotifier, AsyncValue<Coordinates>>((ref) {
  return LocationNotifier(ref);
});


class LocationNotifier extends StateNotifier<AsyncValue<Coordinates>> {
  final Ref _ref;
  final MockLocationService _locationService = MockLocationService();


  LocationNotifier(this._ref) : super(const AsyncValue.loading()) {
    fetchCurrentLocation();
  }


  Future<void> fetchCurrentLocation() async {
    state = const AsyncValue.loading();
    try {
      final location = await _locationService.getCurrentLocation();
      state = AsyncValue.data(location);
    } catch (e, stack) {
      state = AsyncValue.error(e, stack);
    }
  }


  void setLocation(Coordinates coordinates) {
    state = AsyncValue.data(coordinates);
  }
}
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:amenities_kenya/services/mock_order_service.dart';


final orderProvider = StateNotifierProvider<OrderNotifier, AsyncValue<List<Order>>>((ref) {
  return OrderNotifier(ref);
});


class OrderNotifier extends StateNotifier<AsyncValue<List<Order>>> {
  final Ref _ref;
  final MockOrderService _orderService = MockOrderService();


  OrderNotifier(this._ref) : super(const AsyncValue.data([]));


  Future<void> fetchUserOrders(String userId) async {
    state = const AsyncValue.loading();
    try {
      final orders = await _orderService.getUserOrders(userId);
      state = AsyncValue.data(orders);
    } catch (e, stack) {
      state = AsyncValue.error(e, stack);
    }
  }


  Future<void> createOrder(Order order) async {
    try {
      final newOrder = await _orderService.createOrder(order);
      state.whenData((orders) {
        state = AsyncValue.data([...orders, newOrder]);
      });
    } catch (e, stack) {
      state = AsyncValue.error(e, stack);
    }
  }
}






import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/services/mock_supplier_service.dart';
import 'package:amenities_kenya/providers/location_provider.dart';
import 'package:amenities_kenya/utilities/distance_calculator.dart';


final supplierProvider =
    StateNotifierProvider.autoDispose<SupplierNotifier, AsyncValue<List<Supplier>>>((ref) {
  return SupplierNotifier(ref);
});


class SupplierNotifier extends StateNotifier<AsyncValue<List<Supplier>>> {
  final Ref _ref;
  final MockSupplierService _supplierService = MockSupplierService();
  String? _currentCategory;
  String _sortBy = 'rating';
  Coordinates? _userLocation;
  bool _isDisposed = false;


  SupplierNotifier(this._ref) : super(const AsyncValue.loading()) {
    _ref.watch(locationProvider).whenData((loc) => _userLocation = loc);
  }


  @override
  void dispose() {
    _isDisposed = true;
    super.dispose();
  }


  Future<void> fetchSuppliers(String category) async {
    if (_isDisposed) return;
    _currentCategory = category;
    state = const AsyncValue.loading();
    try {
      final suppliers = await _supplierService.getSuppliersByCategory(category);
      if (_isDisposed) return;
      final sortedSuppliers = _sortSuppliers(suppliers);
      state = AsyncValue.data(sortedSuppliers);
    } catch (e, stack) {
      if (_isDisposed) return;
      state = AsyncValue.error(e, stack);
    }
  }


  void setSortBy(String sortBy) {
    if (_isDisposed) return;
    _sortBy = sortBy;
    state.whenData((suppliers) {
      final sortedSuppliers = _sortSuppliers(suppliers);
      state = AsyncValue.data(sortedSuppliers);
    });
  }


  List<Supplier> _sortSuppliers(List<Supplier> suppliers) {
    final sorted = List<Supplier>.from(suppliers);
    if (_sortBy == 'rating') {
      sorted.sort((a, b) => b.averageRating.compareTo(a.averageRating));
    } else if (_sortBy == 'distance' && _userLocation != null) {
      sorted.sort((a, b) {
        final distA = DistanceCalculator.calculateDistance(
          _userLocation!.lat,
          _userLocation!.lon,
          a.coordinates.lat,
          a.coordinates.lon,
        );
        final distB = DistanceCalculator.calculateDistance(
          _userLocation!.lat,
          _userLocation!.lon,
          b.coordinates.lat,
          b.coordinates.lon,
        );
        return distA.compareTo(distB);
      });
    }
    return sorted;
  }
}
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:amenities_kenya/services/preferences_service.dart';


final themeProvider = StateNotifierProvider<ThemeNotifier, ThemeMode>((ref) {
  return ThemeNotifier(ref.read(preferencesServiceProvider));
});


class ThemeNotifier extends StateNotifier<ThemeMode> {
  final PreferencesService _preferencesService;


  ThemeNotifier(this._preferencesService) : super(ThemeMode.system) {
    _loadTheme();
  }


  Future<void> _loadTheme() async {
    final themeString = await _preferencesService.getTheme();
    state = _themeModeFromString(themeString);
  }


  Future<void> setTheme(ThemeMode themeMode) async {
    state = themeMode;
    await _preferencesService.setTheme(themeMode.toString());
  }


  ThemeMode _themeModeFromString(String? themeString) {
    switch (themeString) {
      case 'ThemeMode.light':
        return ThemeMode.light;
      case 'ThemeMode.dark':
        return ThemeMode.dark;
      default:
        return ThemeMode.system;
    }
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/screens/home_screen.dart';
import 'package:amenities_kenya/screens/past_orders_screen.dart';
import 'package:amenities_kenya/screens/profile_screen.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class BottomNavigationScreen extends ConsumerStatefulWidget {
  const BottomNavigationScreen({super.key});


  @override
  _BottomNavigationScreenState createState() => _BottomNavigationScreenState();
}


class _BottomNavigationScreenState extends ConsumerState<BottomNavigationScreen> {
  int _selectedIndex = 0;


  final List<Widget> _screens = [
    const HomeScreen(),
    const PastOrdersScreen(),
    const ProfileScreen(),
  ];


  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
  }


  @override
  Widget build(BuildContext context) {
    final translations = AppLocalizations.of(context)!;


    return Scaffold(
      body: _screens[_selectedIndex],
      bottomNavigationBar: BottomNavigationBar(
        items: [
          BottomNavigationBarItem(
            icon: const Icon(Icons.home),
            label: translations.home,
          ),
          BottomNavigationBarItem(
            icon: const Icon(Icons.history),
            label: translations.pastOrders,
          ),
          BottomNavigationBarItem(
            icon: const Icon(Icons.person),
            label: translations.profile,
          ),
        ],
        currentIndex: _selectedIndex,
        selectedItemColor: Theme.of(context).primaryColor,
        onTap: _onItemTapped,
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/providers/auth_provider.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class HomeScreen extends ConsumerStatefulWidget {
  const HomeScreen({super.key});


  @override
  _HomeScreenState createState() => _HomeScreenState();
}


class _HomeScreenState extends ConsumerState<HomeScreen> {
  final _categories = [
    'gasSupply',
    'cleanWater',
    'drinkingWater',
    'toiletEmptying',
    'garbageDisposal',
  ];


  @override
  Widget build(BuildContext context) {
    final user = ref.watch(userProvider);
    final translations = AppLocalizations.of(context)!;
    const Color navyBlue = Color(0xFF191970);


    const TextStyle cardTextStyle = TextStyle(
      fontSize: 18,
      fontWeight: FontWeight.w600,
      color: navyBlue,
      height: 1.3,
    );


    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        actions: [
          IconButton(
            icon: const Icon(Icons.person, color: navyBlue),
            onPressed: () {
              Navigator.pushNamed(context, NavigationService.profile);
            },
          ),
          IconButton(
            icon: const Icon(Icons.logout, color: navyBlue),
            onPressed: () async {
              await ref.read(userProvider.notifier).logout();
              Navigator.pushReplacementNamed(context, NavigationService.login);
            },
          ),
        ],
      ),
      body: SafeArea(
        child: LayoutBuilder(
          builder: (context, constraints) {
            return SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 20.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.center,
                children: [
                  const SizedBox(height: 16.0),
                  // Gas Supply Card (Centered)
                  SizedBox(
                    width: double.infinity,
                    child: _ServiceCard(
                      label: translations.getTranslation('gasSupply'),
                      imagePath: 'assets/images/gas.jpg',
                      textStyle: cardTextStyle,
                      imageHeight: 150,
                      onTap: () {
                        Navigator.pushNamed(
                          context,
                          NavigationService.locationInput,
                          arguments: {'category': translations.getTranslation('gasSupply')},
                        );
                      },
                    ),
                  ),
                  const SizedBox(height: 20.0),
                  // Clean Water and Drinking Water Row
                  IntrinsicHeight(
                    child: Row(
                      children: [
                        Expanded(
                          child: _ServiceCard(
                            label: translations.getTranslation('cleanWater'),
                            imagePath: 'assets/images/clean_water.png',
                            textStyle: cardTextStyle,
                            imageHeight: 120,
                            onTap: () {
                              Navigator.pushNamed(
                                context,
                                NavigationService.locationInput,
                                arguments: {'category': translations.getTranslation('cleanWater')},
                              );
                            },
                          ),
                        ),
                        const SizedBox(width: 20.0),
                        Expanded(
                          child: _ServiceCard(
                            label: translations.getTranslation('drinkingWater'),
                            imagePath: 'assets/images/drink_water.png',
                            textStyle: cardTextStyle,
                            imageHeight: 120,
                            onTap: () {
                              Navigator.pushNamed(
                                context,
                                NavigationService.locationInput,
                                arguments: {'category': translations.getTranslation('drinkingWater')},
                              );
                            },
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 20.0),
                  // Toilet Emptying and Garbage Disposal Row
                  IntrinsicHeight(
                    child: Row(
                      children: [
                        Expanded(
                          child: _ServiceCard(
                            label: translations.getTranslation('toiletEmptying'),
                            imagePath: 'assets/images/exhauster.png',
                            textStyle: cardTextStyle,
                            imageHeight: 120,
                            onTap: () {
                              Navigator.pushNamed(
                                context,
                                NavigationService.locationInput,
                                arguments: {'category': translations.getTranslation('toiletEmptying')},
                              );
                            },
                          ),
                        ),
                        const SizedBox(width: 20.0),
                        Expanded(
                          child: _ServiceCard(
                            label: translations.getTranslation('garbageDisposal'),
                            imagePath: 'assets/images/garbage.png',
                            textStyle: cardTextStyle,
                            imageHeight: 120,
                            onTap: () {
                              Navigator.pushNamed(
                                context,
                                NavigationService.locationInput,
                                arguments: {'category': translations.getTranslation('garbageDisposal')},
                              );
                            },
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 24.0),
                ],
              ),
            );
          },
        ),
      ),
    );
  }
}


class _ServiceCard extends StatelessWidget {
  const _ServiceCard({
    required this.label,
    required this.imagePath,
    required this.textStyle,
    required this.onTap,
    required this.imageHeight,
  });


  final String label;
  final String imagePath;
  final TextStyle textStyle;
  final VoidCallback onTap;
  final double imageHeight;


  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12.0, vertical: 24.0),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(25.0),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.08),
              spreadRadius: 1,
              blurRadius: 10,
              offset: const Offset(0, 5),
            ),
          ],
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Image.asset(
              imagePath,
              height: imageHeight,
              fit: BoxFit.contain,
            ),
            const SizedBox(height: 16),
            Text(
              label,
              textAlign: TextAlign.center,
              style: textStyle,
              maxLines: 2,
              overflow: TextOverflow.ellipsis,
            ),
          ],
        ),
      ),
    );
  }
}


extension AppLocalizationsExtension on AppLocalizations {
  String getTranslation(String key) {
    switch (key) {
      case 'cleanWater':
        return cleanWater;
      case 'gasSupply':
        return gasSupply;
      case 'drinkingWater':
        return drinkingWater;
      case 'garbageDisposal':
        return garbageDisposal;
      case 'toiletEmptying':
        return toiletEmptying;
      default:
        return '';
    }
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/providers/location_provider.dart';
import 'package:amenities_kenya/services/google_maps_service.dart';
import 'package:amenities_kenya/utilities/dialogs.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_typeahead/flutter_typeahead.dart';
import 'package:lottie/lottie.dart';


final googleMapsServiceProvider = Provider<GoogleMapsService>((ref) {
  // Replace with your actual Google Maps API key
  const apiKey = 'AIzaSyAaqWjbul7rblbie3MSYw-5Kvv7L5ZKxYs';
  return GoogleMapsService(apiKey);
});


class LocationInputScreen extends ConsumerStatefulWidget {
  final String category;


  const LocationInputScreen({super.key, required this.category});


  @override
  _LocationInputScreenState createState() => _LocationInputScreenState();
}


class _LocationInputScreenState extends ConsumerState<LocationInputScreen> {
  final _addressController = TextEditingController();
  final _formKey = GlobalKey<FormState>();
  bool _isLoading = false;
  Coordinates? _selectedCoordinates;


  @override
  void dispose() {
    _addressController.dispose();
    super.dispose();
  }


  Future<void> _useCurrentLocation() async {
    setState(() => _isLoading = true);
    try {
      final googleMapsService = ref.read(googleMapsServiceProvider);
      final location = await googleMapsService.getCurrentLocation();


         // FIX 1: Check if the widget is still mounted after getting location
      if (!mounted) return;


      final address = await googleMapsService.getAddressFromCoordinates(
        location.lat,
        location.lon,
      );
    // It's now safe to update the UI and navigate
      _addressController.text = address;
      _selectedCoordinates = location;
      ref.read(locationProvider.notifier).setLocation(location);
      Navigator.pushNamed(
        context,
        NavigationService.supplierSelection,
        arguments: {
          'category': widget.category,
          'address': _addressController.text,
          'coordinates': location,
        },
      );
    } catch (e) {
            if (!mounted) return;


      CustomDialogs.showErrorDialog(
        context: context,
        title: AppLocalizations.of(context)!.error,
        content: e.toString(),
      );
    } finally {
      setState(() => _isLoading = false);
    }
  }


  Future<void> _submitAddress() async {
    if (!_formKey.currentState!.validate()) return;
    if (_selectedCoordinates == null) {
      CustomDialogs.showErrorDialog(
        context: context,
        title: AppLocalizations.of(context)!.error,
        content: AppLocalizations.of(context)!.selectValidAddress,
      );
      return;
    }


        if (!mounted) return;


    ref.read(locationProvider.notifier).setLocation(_selectedCoordinates!);
    Navigator.pushNamed(
      context,
      NavigationService.supplierSelection,
      arguments: {
        'category': widget.category,
        'address': _addressController.text,
        'coordinates': _selectedCoordinates,
      },
    );
  }


  @override
  Widget build(BuildContext context) {
    final translations = AppLocalizations.of(context)!;
    final googleMapsService = ref.read(googleMapsServiceProvider);
    final screenHeight = MediaQuery.of(context).size.height;


    return Scaffold(
      appBar: AppBar(title: Text(translations.enterLocation)),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Form(
          key: _formKey,
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              // Info box with bulb icon, text, and Lottie animation
              Container(
                padding: const EdgeInsets.all(12.0),
                margin: const EdgeInsets.only(bottom: 4.0),
                decoration: BoxDecoration(
                  color: Colors.blue[50],
                  borderRadius: BorderRadius.circular(8.0),
                  border: Border.all(color: Colors.blueAccent, width: 1.0),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Bulb icon and text
                    Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Icon(
                          Icons.lightbulb_outline,
                          color: Colors.blueAccent,
                          size: 24.0,
                        ),
                        const SizedBox(width: 8.0),
                        Expanded(
                          child: Text(
                            // translations.locationInfoMessage ??
                                'We need your delivery address to find the nearest suppliers for ${widget.category}.',
                            style: const TextStyle(
                              fontSize: 14.0,
                              color: Colors.blueGrey,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 12.0),
                    // Lottie animation
                   
                  ],
                ),
              ),
              Container(
                padding: const EdgeInsets.all(12.0),
                margin: const EdgeInsets.only(bottom: 8.0),
                decoration: BoxDecoration(
                  // color: Colors.blue[50],
                  borderRadius: BorderRadius.circular(8.0),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  children: [
                    // Bulb icon and text
                    SizedBox(
                      height: screenHeight * 2 / 8, // 3/8 of screen height
                      child: Lottie.asset('assets/images/delivery_json.json'),
                    ),
                  ],
                ),
              ),
               TypeAheadField<Map<String, dynamic>>(
                  builder: (context, controller, focusNode) => TextFormField(
                    // IMPORTANT: You are already using _addressController here.
                    // The `builder` provides a controller, but you should use your own
                    // to link it to the rest of the state.
                    controller: _addressController,
                    focusNode: focusNode,
                    decoration: InputDecoration(
                      labelText: translations.deliveryAddress,
                      icon: const Icon(Icons.location_on),
                    ),
                    validator: (value) =>
                        value!.isEmpty ? translations.addressRequired : null,
                  ),
                  suggestionsCallback: (pattern) async {
                    if (pattern.isEmpty) return [];
                    // Using a try-catch here is great!
                    return await googleMapsService.getPlaceSuggestions(pattern);
                  },
                  itemBuilder: (context, Map<String, dynamic> suggestion) {
                    return ListTile(
                      title: Text(suggestion['description'] ?? 'No description'),
                    );
                  },
                  onSelected: (Map<String, dynamic> suggestion) async {
                    try {
                      final placeId = suggestion['place_id'] as String;


                      // --- ASYNC GAP 3 ---
                      final details = await googleMapsService.getPlaceDetails(placeId);


                      // FIX 5: The most critical fix for the TextEditingController error!
                      if (!mounted) return;


                      // Now it's safe to update the controller and state
                      _addressController.text = details['formatted_address'] ?? '';
                      final location = details['geometry']['location'];
                      setState(() {
                        _selectedCoordinates = Coordinates(
                          lat: location['lat'] as double,
                          lon: location['lng'] as double,
                        );
                      });
                    } catch (e) {
                      if (!mounted) return;
                      CustomDialogs.showErrorDialog(
                        context: context,
                        title: translations.error,
                        content: e.toString(),
                      );
                    }
                  },
                  emptyBuilder: (context) => const ListTile(
                    title: Text('No results found'),
                  ),
                ),
                const SizedBox(height: 16.0),
              ElevatedButton(
                onPressed: _submitAddress,
                child: Text(translations.submit),
              ),
              const SizedBox(height: 16.0),
           TextButton(
                  onPressed: _isLoading ? null : _useCurrentLocation,
                  child: _isLoading
                      ? const SizedBox( // Use a sized box for consistent height
                          height: 20,
                          width: 20,
                          child: CircularProgressIndicator(strokeWidth: 2.0),
                        )
                      : Text(translations.useCurrentLocation),
                ),
            ],
          ),
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/providers/auth_provider.dart';
import 'package:amenities_kenya/screens/otp_verification_screen.dart';
import 'package:amenities_kenya/utilities/dialogs.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl_phone_field/intl_phone_field.dart';
import 'package:lottie/lottie.dart';


class LoginScreen extends ConsumerStatefulWidget {
  const LoginScreen({super.key});


  @override
  _LoginScreenState createState() => _LoginScreenState();
}


class _LoginScreenState extends ConsumerState<LoginScreen> {
  final _formKey = GlobalKey<FormState>();
  String _phoneNumber = '';
  bool _isLoading = false;


  Future<void> _handleSendOtp() async {
    if (!_formKey.currentState!.validate()) return;


    setState(() => _isLoading = true);
    try {
      final otp = await ref.read(userProvider.notifier).sendOtp(_phoneNumber);
      if (mounted) {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => OtpVerificationScreen(
              phoneNumber: _phoneNumber,
              isRegistration: false,
            ),
          ),
        );
        CustomDialogs.showSuccessDialog(
          context: context,
          title: AppLocalizations.of(context)!.success,
          content: 'OTP sent: $otp', // For demo purposes
        );
      }
    } catch (e) {
      if (mounted) {
        CustomDialogs.showErrorDialog(
          context: context,
          title: AppLocalizations.of(context)!.error,
          content: e.toString(),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }


  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final translations = AppLocalizations.of(context)!;
    final theme = Theme.of(context);


    return Scaffold(
      backgroundColor: Colors.white,
      body: SafeArea(
        child: LayoutBuilder(
          builder: (context, constraints) {
            return SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 24.0),
              child: ConstrainedBox(
                constraints: BoxConstraints(minHeight: constraints.maxHeight),
                child: IntrinsicHeight(
                  child: Form(
                    key: _formKey,
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        SizedBox(height: size.height * 0.1),
                        // Logo
                        Center(
                          child: Image.asset(
                            'assets/images/logo_amenities.png', // Use provided image
                            width: 150, // Match original Lottie dimensions
                            height: 150,
                            fit: BoxFit.contain, // Ensure image scales properly
                          ),
                        ),
                        const SizedBox(height: 32.0),
                        // Description
                        Text(
                          // translations.enterPhoneNumber,
                          "'We will send you a code by SMS to confirm your phone number",
                          style: TextStyle(
                            fontSize: 16,
                            color: Colors.grey[600],
                          ),
                        ),
                        const SizedBox(height: 16.0),
                        // Phone Number Input
                        IntlPhoneField(
                          decoration: InputDecoration(
                            labelText: translations.phoneNumber,
                            filled: true,
                            fillColor: Colors.grey[200],
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(24.0),
                              borderSide: BorderSide.none,
                            ),
                            enabledBorder: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(24.0),
                              borderSide: BorderSide.none,
                            ),
                            focusedBorder: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(24.0),
                              borderSide: BorderSide(color: Colors.blue[900]!),
                            ),
                          ),
                          initialCountryCode: 'KE',
                          disableLengthCheck: true,
                          onChanged: (phone) {
                            _phoneNumber = phone.completeNumber;
                            print(phone.completeNumber);
                          },
                          validator: (phone) {
                            if (phone == null || phone.number.isEmpty) {
                              return translations.phoneRequired;
                            }
                            if (phone.number.length != 9) {
                              return 'Please enter a valid 9-digit number.';
                            }
                            return null;
                          },
                        ),
                        const Spacer(),
                        // Terms and Conditions
                        Text(
                          'If you sign up, you confirm to have read in detail and agreed to the Terms & Conditions and Privacy Policy.',
                          textAlign: TextAlign.center,
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.grey[600],
                          ),
                        ),
                        const SizedBox(height: 16.0),
                        // Next Button
                        ElevatedButton(
                          onPressed: _isLoading ? null : _handleSendOtp,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.blue[900],
                            foregroundColor: Colors.white,
                            minimumSize: const Size(double.infinity, 50),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(24.0),
                            ),
                            elevation: 0,
                          ),
                          child: _isLoading
                              ? const CircularProgressIndicator(
                                  color: Colors.white,
                                  strokeWidth: 2.0,
                                )
                              : Text(
                                  translations.sendOtp,
                                  style: const TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                        ),
                        const SizedBox(height: 16.0),
                        // Sign Up Link
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Text(translations.noAccount),
                            TextButton(
                              onPressed: () {
                                Navigator.pushNamed(
                                  context,
                                  NavigationService.register,
                                );
                              },
                              child: Text(
                                translations.signUp,
                                style: const TextStyle(
                                  fontWeight: FontWeight.bold,
                                  fontSize: 16,
                                ),
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 24.0),
                      ],
                    ),
                  ),
                ),
              ),
            );
          },
        ),
      ),
    );
  }
}


import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/services/preferences_service.dart';
import 'package:amenities_kenya/utilities/dialogs.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:dots_indicator/dots_indicator.dart';


class OnboardingScreen extends ConsumerStatefulWidget {
  const OnboardingScreen({super.key});


  @override
  _OnboardingScreenState createState() => _OnboardingScreenState();
}


class _OnboardingScreenState extends ConsumerState<OnboardingScreen> {
  final _pageController = PageController();
  int _currentPage = 0;


  final List<Map<String, String>> _pages = [
    {
      'title': 'welcome',
      'description': 'welcomeDescription',
      'image': 'assets/images/intro1.jpeg',
    },
    {
      'title': 'selectServices',
      'description': 'selectServicesDescription',
      'image': 'assets/images/intro2.jpeg',
    },
    {
      'title': 'trackOrders',
      'description': 'trackOrdersDescription',
      'image': 'assets/images/intro3.jpeg',
    },
  ];


  String _getTranslation(AppLocalizations translations, String key) {
    switch (key) {
      case 'welcome':
        return translations.welcome;
      case 'welcomeDescription':
        return translations.welcomeDescription;
      case 'selectServices':
        return translations.selectServices;
      case 'selectServicesDescription':
        return translations.selectServicesDescription;
      case 'trackOrders':
        return translations.trackOrders;
      case 'trackOrdersDescription':
        return translations.trackOrdersDescription;
      default:
        return '';
    }
  }


  Future<void> _setHasSeenOnboarding() async {
    try {
      await ref.read(preferencesServiceProvider).setHasSeenOnboarding(true);
      if (mounted) {
        Navigator.pushReplacementNamed(context, NavigationService.login);
      }
    } catch (e) {
      if (mounted) {
        CustomDialogs.showErrorDialog(
          context: context,
          title: AppLocalizations.of(context)!.error,
          content: e.toString(),
        );
      }
    }
  }


  void _handleNextButton() {
    if (_currentPage == _pages.length - 1) {
      _setHasSeenOnboarding();
    } else {
      setState(() {
        _currentPage++;
        _pageController.animateToPage(
          _currentPage,
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeInOut,
        );
      });
    }
  }


  void _handleSkipButton() {
    _setHasSeenOnboarding();
  }


  @override
  void dispose() {
    _pageController.dispose();
    super.dispose();
  }


  @override
  Widget build(BuildContext context) {
    final translations = AppLocalizations.of(context)!;
    final size = MediaQuery.of(context).size;


    return Scaffold(
      resizeToAvoidBottomInset: false,
      backgroundColor: Colors.white,
      body: SafeArea(
        child: Column(
          children: [
            // Skip button
            Align(
              alignment: Alignment.topRight,
              child: Padding(
                padding: const EdgeInsets.all(16.0),
                child: TextButton(
                  onPressed: _handleSkipButton,
                  child: Text(
                    'Skip',
                    style: TextStyle(
                      color: Colors.grey[600],
                      fontSize: 16,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
              ),
            ),
            // Page view
            Expanded(
              child: PageView.builder(
                controller: _pageController,
                onPageChanged: (index) => setState(() => _currentPage = index),
                itemCount: _pages.length,
                itemBuilder: (context, index) {
                  return Column(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      // Image at top
                      Padding(
                        padding: const EdgeInsets.only(top: 24.0),
                        child: Image.asset(
                          _pages[index]['image']!,
                          width: size.width * 0.6, // Scale to 60% of screen width
                          fit: BoxFit.contain,
                        ),
                      ),
                      // Spacer to push text to bottom
                      const Spacer(),
                      // Text at bottom
                      Padding(
                        padding: const EdgeInsets.only(left: 40, right: 40, bottom: 20),
                        child: Column(
                          children: [
                            Text(
                              _getTranslation(translations, _pages[index]['title']!),
                              textAlign: TextAlign.center,
                              style: Theme.of(context).textTheme.displayMedium,
                            ),
                            Padding(
                              padding: const EdgeInsets.only(top: 20),
                              child: Text(
                                _getTranslation(translations, _pages[index]['description']!),
                                textAlign: TextAlign.center,
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),
            // Bottom navigation
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 20),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  DotsIndicator(
                    dotsCount: _pages.length,
                    position: _currentPage.toDouble(),
                    decorator: DotsDecorator(
                      activeColor: Colors.blue[800],
                      size: const Size.square(8.0),
                      activeSize: const Size(24.0, 8.0),
                      activeShape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(5.0),
                      ),
                    ),
                  ),
                  ElevatedButton(
                    onPressed: _handleNextButton,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.blue[800],
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                      elevation: 2,
                      minimumSize: const Size(0, 48), // Allow button to expand
                    ),
                    child: Text(
                      _currentPage == _pages.length - 1 ? 'Get Started' : 'Next',
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:amenities_kenya/widgets/order_item_widget.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';


class OrderConfirmationScreen extends ConsumerWidget {
  const OrderConfirmationScreen({super.key});


 
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final args = ModalRoute.of(context)!.settings.arguments as Map<String, dynamic>;
    final supplier = args['supplier'] as Supplier;
    final orderDetails = args['orderDetails'] as OrderDetails;
    final deliveryAddress = args['deliveryAddress'] as DeliveryAddress;
    final schedule = args['schedule'] as Schedule;
    final instructions = args['instructions'] as String;
    final translations = AppLocalizations.of(context)!;




    return Scaffold(
      appBar: AppBar(
        title: Text(
          translations.orderConfirmation,
          style: Theme.of(context).textTheme.titleLarge!.copyWith(
                fontWeight: FontWeight.w600,
              ),
        ),
        elevation: 0,
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      ),
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.all(8.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(
                constraints: const BoxConstraints(maxWidth: 500), // Limit content width
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Card(
                      // elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(8.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.shopping_cart_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.orderDetails,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            OrderItemWidget(details: orderDetails, category: supplier.category),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.store_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.supplier,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              supplier.name,
                              style: Theme.of(context).textTheme.bodyLarge,
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.location_on_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.deliveryAddress,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              deliveryAddress.address,
                              style: Theme.of(context).textTheme.bodyLarge,
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.schedule_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.schedule,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              schedule.type,
                              style: Theme.of(context).textTheme.bodyLarge,
                            ),
                            if (schedule.dateTime != null)
                              Text(
                                DateFormat('yyyy-MM-dd HH:mm')
                                    .format(DateTime.parse(schedule.dateTime!).toLocal()),
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            if (schedule.day != null)
                              Text(
                                '${translations.day}: ${schedule.day}',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            if (schedule.time != null)
                              Text(
                                '${translations.time}: ${schedule.time}',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            if (schedule.dayOfMonth != null)
                              Text(
                                '${translations.dayOfMonth}: ${schedule.dayOfMonth}',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                          ],
                        ),
                      ),
                    ),
                    if (instructions.isNotEmpty) ...[
                      const SizedBox(height: 8.0),
                      Card(
                        elevation: 2,
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        child: Padding(
                          padding: const EdgeInsets.all(16.0),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Row(
                                children: [
                                  Icon(
                                    Icons.note_outlined,
                                    color: Theme.of(context).colorScheme.primary,
                                    size: 20,
                                  ),
                                  const SizedBox(width: 8),
                                  Text(
                                    translations.instructions,
                                    style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                          fontWeight: FontWeight.w600,
                                        ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 8.0),
                              Text(
                                instructions,
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.monetization_on_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.totalCost,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              '\$${orderDetails.totalCost.toStringAsFixed(2)}',
                              style: Theme.of(context).textTheme.bodyLarge!.copyWith(
                                    fontWeight: FontWeight.w600,
                                  ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 32.0),
           Row(
  children: [
    Expanded(
      flex: 1,
      child: TextButton.icon(
        icon: const Icon(Icons.arrow_back),
        label: Text(translations.back),
        onPressed: () => Navigator.pop(context),
        style: TextButton.styleFrom(
          // Set a minimum size with infinite width to make it expand
          minimumSize: const Size.fromHeight(52), // <-- ADD THIS
          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
            side: BorderSide(
              color: Theme.of(context).colorScheme.primary.withOpacity(0.3),
            ),
          ),
        ),
      ),
    ),
    const SizedBox(width: 16),
    Expanded(
      flex: 1,
      child: ElevatedButton.icon(
        icon: const Icon(Icons.check),
        label: Text(translations.confirm),
        onPressed: () {
          Navigator.pushNamed(
            context,
            NavigationService.orderSummary,
            arguments: {
              'supplier': supplier,
              'orderDetails': orderDetails,
              'deliveryAddress': deliveryAddress,
              'schedule': schedule,
              'instructions': instructions,
            },
          );
        },
        style: ElevatedButton.styleFrom(
          // Set a minimum size with infinite width to make it expand
          minimumSize: const Size.fromHeight(52), // <-- ADD THIS
          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
        ),
      ),
    ),
  ],
)
            ],
          ),
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/utilities/distance_calculator.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class OrderCustomizationScreen extends ConsumerStatefulWidget {
  const OrderCustomizationScreen({super.key});


  @override
  _OrderCustomizationScreenState createState() => _OrderCustomizationScreenState();
}


class _OrderCustomizationScreenState extends ConsumerState<OrderCustomizationScreen> {
  String? _selectedType;
  String? _selectedSize;
  String? _selectedBrand;
  String? _selectedAccessory;
  int _quantity = 1;
  int _bags = 1;
  int _trips = 1;
  double _liters = 100;
  double _totalCost = 0.0;
  double _deliveryFee = 0.0;


  @override
  Widget build(BuildContext context) {
    final args = ModalRoute.of(context)!.settings.arguments as Map<String, dynamic>;
    final supplier = args['supplier'] as Supplier;
    final deliveryCoordinates = args['coordinates'] as Coordinates;
    final translations = AppLocalizations.of(context)!;


    _calculateCost(supplier, deliveryCoordinates);


    return Scaffold(
      appBar: AppBar(
        title: Text(
          translations.customizeOrder,
          style: Theme.of(context).textTheme.titleLarge!.copyWith(
                fontWeight: FontWeight.w600,
              ),
        ),
        elevation: 0,
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: SingleChildScrollView(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Card(
                elevation: 3,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Icon(
                            Icons.store,
                            color: Theme.of(context).colorScheme.primary,
                            size: 24,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            supplier.name,
                            style: Theme.of(context).textTheme.displayMedium!.copyWith(
                                  fontWeight: FontWeight.w700,
                                ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 16.0),
                      _buildCustomizationForm(supplier, translations),
                      const SizedBox(height: 24.0),
                      Row(
                        children: [
                          Icon(
                            Icons.monetization_on,
                            color: Theme.of(context).colorScheme.primary,
                            size: 24,
                          ),
                          const SizedBox(width: 8),
                          Text(
                            '${translations.totalCost}: \$${_totalCost.toStringAsFixed(2)}',
                            style: Theme.of(context).textTheme.bodyLarge!.copyWith(
                                  fontWeight: FontWeight.w600,
                                ),
                          ),
                        ],
                      ),
                    ],
                  ),
                ),
              ),
              const SizedBox(height: 24.0),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton.icon(
                  icon: const Icon(Icons.arrow_forward),
                  label: Text(translations.proceed),
                  onPressed: () {
                    Navigator.pushNamed(
                      context,
                      NavigationService.scheduling,
                      arguments: {
                        'supplier': supplier,
                        'orderDetails': _buildOrderDetails(),
                        'deliveryCoordinates': deliveryCoordinates,
                        'deliveryAddress': args['address'],
                      },
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }


  Widget _buildCustomizationForm(Supplier supplier, AppLocalizations translations) {
    return Container(
      constraints: const BoxConstraints(maxWidth: 500), // Limit dropdown width
      child: Column(
        children: [
          const SizedBox(height: 8.0),
          switch (supplier.category) {
            'Clean Water Services' => Column(
                children: [
                  TextFormField(
                    initialValue: _liters.toString(),
                    keyboardType: TextInputType.number,
                    decoration: InputDecoration(
                      labelText: translations.liters,
                      prefixIcon: const Icon(Icons.water_drop, size: 20),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    onChanged: (value) {
                      setState(() => _liters = double.tryParse(value) ?? 100);
                    },
                  ),
                ],
              ),
            'Gas Supply and Refill' => Column(
                children: [
                  DropdownButtonFormField<String>(
                    value: _selectedType,
                    decoration: InputDecoration(
                      labelText: translations.itemType,
                      prefixIcon: const Icon(Icons.propane_tank, size: 20),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    items: [
                      'New Cylinder',
                      'New Cylinder with Gas',
                      'Refill',
                      'Accessory',
                    ].map((type) => DropdownMenuItem(value: type, child: Text(type))).toList(),
                    onChanged: (value) {
                      setState(() {
                        _selectedType = value;
                        _selectedSize = null;
                        _selectedBrand = null;
                        _selectedAccessory = null;
                      });
                    },
                  ),
                  if (_selectedType != 'Accessory' && _selectedType != null) ...[
                    const SizedBox(height: 16.0),
                    DropdownButtonFormField<String>(
                      value: _selectedBrand,
                      decoration: InputDecoration(
                        labelText: translations.brand,
                        prefixIcon: const Icon(Icons.branding_watermark, size: 20),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      items: supplier.pricing.cylinders!
                          .map((c) => c.brand)
                          .toSet()
                          .map((brand) => DropdownMenuItem(value: brand, child: Text(brand)))
                          .toList(),
                      onChanged: (value) => setState(() => _selectedBrand = value),
                    ),
                    const SizedBox(height: 16.0),
                    DropdownButtonFormField<String>(
                      value: _selectedSize,
                      decoration: InputDecoration(
                        labelText: translations.size,
                        prefixIcon: const Icon(Icons.scale, size: 20),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      items: supplier.pricing.cylinders!
                          .where((c) => c.brand == _selectedBrand)
                          .map((c) => c.size)
                          .map((size) => DropdownMenuItem(value: size, child: Text(size)))
                          .toList(),
                      onChanged: (value) => setState(() => _selectedSize = value),
                    ),
                  ],
                  if (_selectedType == 'Accessory') ...[
                    const SizedBox(height: 16.0),
                    DropdownButtonFormField<String>(
                      value: _selectedAccessory,
                      decoration: InputDecoration(
                        labelText: translations.accessory,
                        prefixIcon: const Icon(Icons.build, size: 20),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      items: supplier.pricing.accessories!
                          .map((a) => DropdownMenuItem(value: a.name, child: Text(a.name)))
                          .toList(),
                      onChanged: (value) => setState(() => _selectedAccessory = value),
                    ),
                  ],
                ],
              ),
            'Drinking Water' => Column(
                children: [
                  DropdownButtonFormField<String>(
                    value: _selectedType,
                    decoration: InputDecoration(
                      labelText: translations.itemType,
                      prefixIcon: const Icon(Icons.local_drink, size: 20),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    items: [
                      'New Bottle',
                      'New Bottle with Water',
                      'Refill',
                    ].map((type) => DropdownMenuItem(value: type, child: Text(type))).toList(),
                    onChanged: (value) {
                      setState(() {
                        _selectedType = value;
                        _selectedSize = null;
                      });
                    },
                  ),
                  if (_selectedType != null) ...[
                    const SizedBox(height: 16.0),
                    DropdownButtonFormField<String>(
                      value: _selectedSize,
                      decoration: InputDecoration(
                        labelText: translations.size,
                        prefixIcon: const Icon(Icons.scale, size: 20),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      items: supplier.pricing.bottles!
                          .map((b) => DropdownMenuItem(value: b.size, child: Text(b.size)))
                          .toList(),
                      onChanged: (value) => setState(() => _selectedSize = value),
                    ),
                    const SizedBox(height: 16.0),
                    TextFormField(
                      initialValue: _quantity.toString(),
                      keyboardType: TextInputType.number,
                      decoration: InputDecoration(
                        labelText: translations.quantity,
                        prefixIcon: const Icon(Icons.add_circle_outline, size: 20),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      onChanged: (value) {
                        setState(() => _quantity = int.tryParse(value) ?? 1);
                      },
                    ),
                  ],
                ],
              ),
            'Garbage Disposal' => Column(
                children: [
                  DropdownButtonFormField<String>(
                    value: _selectedType,
                    decoration: InputDecoration(
                      labelText: translations.itemType,
                      prefixIcon: const Icon(Icons.delete_outline, size: 20),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    items: [
                      'Collection',
                      'Bags Only',
                    ].map((type) => DropdownMenuItem(value: type, child: Text(type))).toList(),
                    onChanged: (value) => setState(() => _selectedType = value),
                  ),
                  if (_selectedType != null) ...[
                    const SizedBox(height: 16.0),
                    TextFormField(
                      initialValue: _bags.toString(),
                      keyboardType: TextInputType.number,
                      decoration: InputDecoration(
                        labelText: translations.bags,
                        prefixIcon: const Icon(Icons.delete, size: 20),
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      onChanged: (value) {
                        setState(() => _bags = int.tryParse(value) ?? 1);
                      },
                    ),
                  ],
                ],
              ),
            'Toilet/Latrine/Septic Tank Emptying' => Column(
                children: [
                  TextFormField(
                    initialValue: _trips.toString(),
                    keyboardType: TextInputType.number,
                    decoration: InputDecoration(
                      labelText: translations.trips,
                      prefixIcon: const Icon(Icons.local_shipping_outlined, size: 20),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    onChanged: (value) {
                      setState(() => _trips = int.tryParse(value) ?? 1);
                    },
                  ),
                ],
              ),
            _ => const SizedBox.shrink(),
          },
        ],
      ),
    );
  }


  void _calculateCost(Supplier supplier, Coordinates deliveryCoordinates) {
    final distance = DistanceCalculator.calculateDistance(
      supplier.coordinates.lat,
      supplier.coordinates.lon,
      deliveryCoordinates.lat,
      deliveryCoordinates.lon,
    );
    _deliveryFee = (supplier.pricing.deliveryFeePerKm ?? 0) * distance;


    switch (supplier.category) {
      case 'Clean Water Services':
        _totalCost = (_liters * (supplier.pricing.pricePerLiter ?? 0));
        break;
      case 'Gas Supply and Refill':
        if (_selectedType == 'Accessory' && _selectedAccessory != null) {
          final accessory = supplier.pricing.accessories!
              .firstWhere((a) => a.name == _selectedAccessory);
          _totalCost = accessory.price;
        } else if (_selectedType != null &&
            _selectedBrand != null &&
            _selectedSize != null) {
          final cylinder = supplier.pricing.cylinders!
              .firstWhere((c) => c.brand == _selectedBrand && c.size == _selectedSize);
          _totalCost = _selectedType == 'New Cylinder'
              ? cylinder.newPrice
              : _selectedType == 'New Cylinder with Gas'
                  ? cylinder.newPrice + cylinder.refillPrice
                  : cylinder.refillPrice;
        } else {
          _totalCost = 0;
        }
        break;
      case 'Drinking Water':
        if (_selectedType != null && _selectedSize != null) {
          final bottle = supplier.pricing.bottles!
              .firstWhere((b) => b.size == _selectedSize);
          _totalCost = _quantity *
              (_selectedType == 'New Bottle'
                  ? bottle.newPrice
                  : _selectedType == 'New Bottle with Water'
                      ? bottle.newPrice + bottle.refillPrice
                      : bottle.refillPrice);
        } else {
          _totalCost = 0;
        }
        break;
      case 'Garbage Disposal':
        if (_selectedType == 'Collection' && _bags > 0) {
          final collection = supplier.pricing.collection!;
          _totalCost = collection.basePrice;
          if (_bags > collection.bagsIncluded) {
            _totalCost +=
                (_bags - collection.bagsIncluded) * collection.additionalBagPrice;
          }
        } else if (_selectedType == 'Bags Only' && _bags > 0) {
          _totalCost = _bags * (supplier.pricing.bagsOnly!.pricePerBag);
        } else {
          _totalCost = 0;
        }
        break;
      case 'Toilet/Latrine/Septic Tank Emptying':
        _totalCost = _trips * (supplier.pricing.pricePerTrip ?? 0);
        break;
    }
  }


  OrderDetails _buildOrderDetails() {
    switch (_selectedType) {
      case 'Collection':
        return OrderDetails(
          type: _selectedType,
          bags: _bags,
          basePrice: _totalCost,
          additionalBagPrice:
              _bags > 3 ? 3.0 : null, // Assuming 3 bags included
          additionalBags: _bags > 3 ? _bags - 3 : null,
          deliveryFee: _deliveryFee,
          totalCost: _totalCost + _deliveryFee,
        );
      case 'Bags Only':
        return OrderDetails(
          type: _selectedType,
          bags: _bags,
          pricePerBag: 1.0,
          deliveryFee: _deliveryFee,
          totalCost: _totalCost + _deliveryFee,
        );
      case 'New Cylinder':
      case 'New Cylinder with Gas':
      case 'Refill':
        return OrderDetails(
          item: OrderItem(
            type: _selectedType!,
            brand: _selectedBrand,
            size: _selectedSize,
            quantity: 1,
            price: _totalCost,
          ),
          deliveryFee: _deliveryFee,
          totalCost: _totalCost + _deliveryFee,
        );
      case 'Accessory':
        return OrderDetails(
          item: OrderItem(
            type: _selectedType!,
            name: _selectedAccessory,
            quantity: 1,
            price: _totalCost,
          ),
          deliveryFee: _deliveryFee,
          totalCost: _totalCost + _deliveryFee,
        );
      case 'New Bottle':
      case 'New Bottle with Water':
      case 'Refill':
        return OrderDetails(
          item: OrderItem(
            type: _selectedType!,
            size: _selectedSize,
            quantity: _quantity,
            price: _totalCost / _quantity,
          ),
          deliveryFee: _deliveryFee,
          totalCost: _totalCost + _deliveryFee,
        );
      default:
        return OrderDetails(
          liters: _liters,
          pricePerLiter: _totalCost / _liters,
          deliveryFee: _deliveryFee,
          totalCost: _totalCost + _deliveryFee,
          trips: _trips,
          pricePerTrip: _totalCost / _trips,
        );
    }
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/providers/auth_provider.dart';
import 'package:amenities_kenya/providers/order_provider.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:amenities_kenya/widgets/order_item_widget.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';


class OrderSummaryScreen extends ConsumerWidget {
  const OrderSummaryScreen({super.key});


  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final args = ModalRoute.of(context)!.settings.arguments as Map<String, dynamic>;
    final supplier = args['supplier'] as Supplier;
    final orderDetails = args['orderDetails'] as OrderDetails;
    final deliveryAddress = args['deliveryAddress'] as DeliveryAddress;
    final schedule = args['schedule'] as Schedule;
    final instructions = args['instructions'] as String;
    final translations = AppLocalizations.of(context)!;


    return Scaffold(
      appBar: AppBar(
        title: Text(
          translations.orderSummary,
          style: Theme.of(context).textTheme.titleLarge!.copyWith(
                fontWeight: FontWeight.w600,
              ),
        ),
        elevation: 0,
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      ),
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.all(8.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(
                constraints: const BoxConstraints(maxWidth: 500), // Limit content width
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(8.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.shopping_cart_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.orderDetails,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            OrderItemWidget(details: orderDetails, category: supplier.category),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.store_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.supplier,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              supplier.name,
                              style: Theme.of(context).textTheme.bodyLarge,
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.location_on_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.deliveryAddress,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              deliveryAddress.address,
                              style: Theme.of(context).textTheme.bodyLarge,
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.schedule_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.schedule,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              schedule.type,
                              style: Theme.of(context).textTheme.bodyLarge,
                            ),
                            if (schedule.dateTime != null)
                              Text(
                                DateFormat('yyyy-MM-dd HH:mm')
                                    .format(DateTime.parse(schedule.dateTime!).toLocal()),
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            if (schedule.day != null)
                              Text(
                                '${translations.day}: ${schedule.day}',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            if (schedule.time != null)
                              Text(
                                '${translations.time}: ${schedule.time}',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            if (schedule.dayOfMonth != null)
                              Text(
                                '${translations.dayOfMonth}: ${schedule.dayOfMonth}',
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                          ],
                        ),
                      ),
                    ),
                    if (instructions.isNotEmpty) ...[
                      const SizedBox(height: 8.0),
                      Card(
                        elevation: 2,
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        child: Padding(
                          padding: const EdgeInsets.all(16.0),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Row(
                                children: [
                                  Icon(
                                    Icons.note_outlined,
                                    color: Theme.of(context).colorScheme.primary,
                                    size: 20,
                                  ),
                                  const SizedBox(width: 8),
                                  Text(
                                    translations.instructions,
                                    style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                          fontWeight: FontWeight.w600,
                                        ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 8.0),
                              Text(
                                instructions,
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.monetization_on_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.totalCost,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              '\$${orderDetails.totalCost.toStringAsFixed(2)}',
                              style: Theme.of(context).textTheme.bodyLarge!.copyWith(
                                    fontWeight: FontWeight.w600,
                                  ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 32.0),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton.icon(
                  icon: const Icon(Icons.payment),
                  label: Text(translations.placeOrder),
                  onPressed: () {
                    final order = Order(
                      orderId: '',
                      userId: ref.read(userProvider)!.userId,
                      supplierId: supplier.supplierId,
                      category: supplier.category,
                      details: orderDetails,
                      deliveryAddress: deliveryAddress,
                      schedule: schedule,
                      instructions: instructions,
                      status: 'In Progress',
                      createdAt: DateTime.now().toUtc(),
                      estimatedDeliveryTime: schedule.dateTime != null
                          ? DateTime.parse(schedule.dateTime!).add(const Duration(hours: 2))
                          : null,
                    );
                    ref.read(orderProvider.notifier).createOrder(order);
                    Navigator.pushNamed(
                      context,
                      NavigationService.payment,
                      arguments: order,
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    minimumSize: const Size.fromHeight(52),
                    padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/constants.dart';
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:amenities_kenya/providers/order_provider.dart';
import 'package:amenities_kenya/utilities/date_formatter.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:amenities_kenya/widgets/order_item_widget.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class OrderTrackingScreen extends ConsumerWidget {
  const OrderTrackingScreen({super.key});


  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final args = ModalRoute.of(context)!.settings.arguments as Order;
    final translations = AppLocalizations.of(context)!;


    return Scaffold(
      appBar: AppBar(
        title: Text(
          translations.orderTracking,
          style: Theme.of(context).textTheme.titleLarge!.copyWith(
                fontWeight: FontWeight.w600,
              ),
        ),
        elevation: 0,
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      ),
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.all(8.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(
                constraints: const BoxConstraints(maxWidth: 500), // Limit content width
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(8.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.shopping_cart_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.orderDetails,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            OrderItemWidget(
                              details: args.details,
                              category: args.category,
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.track_changes_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.status,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              args.status,
                              style: TextStyle(
                                color: args.status == 'In Progress' ||
                                        args.status == 'Waiting for Confirmation'
                                    ? Theme.of(context).colorScheme.primary
                                    : AppColors.green,
                                fontWeight: FontWeight.w600,
                              ),
                            ),
                            const SizedBox(height: 8.0),
                            LinearProgressIndicator(
                              value: _getStatusProgress(args.status),
                              backgroundColor: AppColors.lightGray,
                              color: Theme.of(context).colorScheme.primary,
                            ),
                          ],
                        ),
                      ),
                    ),
                    if (args.estimatedDeliveryTime != null) ...[
                      const SizedBox(height: 8.0),
                      Card(
                        elevation: 2,
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                        child: Padding(
                          padding: const EdgeInsets.all(16.0),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Row(
                                children: [
                                  Icon(
                                    Icons.access_time_outlined,
                                    color: Theme.of(context).colorScheme.primary,
                                    size: 20,
                                  ),
                                  const SizedBox(width: 8),
                                  Text(
                                    translations.estimatedDelivery,
                                    style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                          fontWeight: FontWeight.w600,
                                        ),
                                  ),
                                ],
                              ),
                              const SizedBox(height: 8.0),
                              Text(
                                DateFormatter.formatDateTime(args.estimatedDeliveryTime!),
                                style: Theme.of(context).textTheme.bodyLarge,
                              ),
                            ],
                          ),
                        ),
                      ),
                    ],
                    const SizedBox(height: 32.0),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        icon: const Icon(Icons.star_rate_outlined),
                        label: Text(translations.rateSupplier),
                        onPressed: args.status == 'Completed' || args.status == 'Fulfilled'
                            ? () {
                                Navigator.pushNamed(
                                  context,
                                  NavigationService.rateSupplier,
                                  arguments: args,
                                );
                              }
                            : null,
                        style: ElevatedButton.styleFrom(
                          minimumSize: const Size.fromHeight(52),
                          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          backgroundColor: Theme.of(context).colorScheme.primary,
                          foregroundColor: Colors.white,
                          disabledBackgroundColor: Theme.of(context).colorScheme.primary.withOpacity(0.5),
                          disabledForegroundColor: Colors.white.withOpacity(0.7),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }


  double _getStatusProgress(String status) {
    switch (status) {
      case 'Waiting for Confirmation':
        return 0.1;
      case 'In Progress':
        return 0.33;
      case 'Fulfilled':
        return 0.66;
      case 'Completed':
        return 1.0;
      default:
        return 0.0;
    }
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/providers/auth_provider.dart';
import 'package:amenities_kenya/utilities/dialogs.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:pin_code_fields/pin_code_fields.dart';


class OtpVerificationScreen extends ConsumerStatefulWidget {
  final String phoneNumber;
  final bool isRegistration;


  const OtpVerificationScreen({
    super.key,
    required this.phoneNumber,
    required this.isRegistration,
  });


  @override
  _OtpVerificationScreenState createState() => _OtpVerificationScreenState();
}


class _OtpVerificationScreenState extends ConsumerState<OtpVerificationScreen> {
  final _formKey = GlobalKey<FormState>();
  final _otpController = TextEditingController();
  bool _isLoading = false;


  @override
  void dispose() {
    _otpController.dispose();
    super.dispose();
  }


  Future<void> _verifyOtp() async {
    if (!_formKey.currentState!.validate()) return;


    setState(() => _isLoading = true);
    try {
      await ref.read(userProvider.notifier).verifyOtp(
            widget.phoneNumber,
            _otpController.text.trim(),
          );
      if (mounted) {
        if (widget.isRegistration) {
          Navigator.pushReplacementNamed(
            context,
            NavigationService.profileSetup,
            arguments: {'phoneNumber': widget.phoneNumber},
          );
        } else {
          CustomDialogs.showSuccessDialog(
            context: context,
            title: AppLocalizations.of(context)!.success,
            content: AppLocalizations.of(context)!.loginSuccess,
          ).then((_) => Navigator.pushReplacementNamed(context, NavigationService.home));
        }
      }
    } catch (e) {
      if (mounted) {
        CustomDialogs.showErrorDialog(
          context: context,
          title: AppLocalizations.of(context)!.error,
          content: 'Invalid OTP. Please try again.',
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }


  Future<void> _resendOtp() async {
    setState(() => _isLoading = true);
    try {
      final otp = await ref.read(userProvider.notifier).sendOtp(widget.phoneNumber);
      if (mounted) {
        CustomDialogs.showSuccessDialog(
          context: context,
          title: AppLocalizations.of(context)!.success,
          content: 'New OTP sent: $otp', // For demo purposes
        );
      }
    } catch (e) {
      if (mounted) {
        CustomDialogs.showErrorDialog(
          context: context,
          title: AppLocalizations.of(context)!.error,
          content: e.toString(),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }


  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final translations = AppLocalizations.of(context)!;
    final theme = Theme.of(context);


    return Scaffold(
      backgroundColor: Colors.white,
      body: SafeArea(
        child: LayoutBuilder(
          builder: (context, constraints) {
            return SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 24.0),
              child: ConstrainedBox(
                constraints: BoxConstraints(minHeight: constraints.maxHeight),
                child: IntrinsicHeight(
                  child: Form(
                    key: _formKey,
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        SizedBox(height: size.height * 0.1),
                        // Logo
                        Center(
                          child: Image.asset(
                            'assets/images/logo_amenities.png',
                            width: 150,
                            height: 150,
                            fit: BoxFit.contain,
                          ),
                        ),
                        const SizedBox(height: 32.0),
                        // Description
                        Text(
                          'Enter the 6-digit code sent to ${widget.phoneNumber}.',
                          style: TextStyle(
                            fontSize: 16,
                            color: Colors.grey[600],
                          ),
                        ),
                        const SizedBox(height: 16.0),
                        // OTP Input
                        PinCodeTextField(
                          appContext: context,
                          controller: _otpController,
                          length: 6,
                          keyboardType: TextInputType.number,
                          animationType: AnimationType.fade,
                          pinTheme: PinTheme(
                            shape: PinCodeFieldShape.box,
                            borderRadius: BorderRadius.circular(8),
                            fieldHeight: 50,
                            fieldWidth: 40,
                            activeFillColor: Colors.grey[200],
                            selectedFillColor: Colors.grey[200],
                            inactiveFillColor: Colors.grey[200],
                            activeColor: Colors.blue[900],
                            selectedColor: Colors.blue[900],
                            inactiveColor: Colors.grey[400],
                          ),
                          validator: (value) {
                            if (value == null || value.length != 6) {
                              return translations.otpInvalid;
                            }
                            return null;
                          },
                        ),
                        const Spacer(),
                        // Verify Button
                        ElevatedButton(
                          onPressed: _isLoading ? null : _verifyOtp,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.blue[900],
                            foregroundColor: Colors.white,
                            minimumSize: const Size(double.infinity, 50),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(24.0),
                            ),
                            elevation: 0,
                          ),
                          child: _isLoading
                              ? const CircularProgressIndicator(
                                  color: Colors.white,
                                  strokeWidth: 2.0,
                                )
                              : Text(
                                  translations.verify,
                                  style: const TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                        ),
                        const SizedBox(height: 16.0),
                        // Resend OTP Link
                        Center(
                          child: TextButton(
                            onPressed: _isLoading ? null : _resendOtp,
                            child: Text(
                              translations.resendOtp,
                              style: const TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: Colors.blue,
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(height: 24.0),
                      ],
                    ),
                  ),
                ),
              ),
            );
          },
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/constants.dart';
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:amenities_kenya/providers/order_provider.dart';
import 'package:amenities_kenya/utilities/dialogs.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class PaymentScreen extends ConsumerStatefulWidget {
  const PaymentScreen({super.key});


  @override
  _PaymentScreenState createState() => _PaymentScreenState();
}


class _PaymentScreenState extends ConsumerState<PaymentScreen> {
  String _paymentMethod = 'M-Pesa';
  bool _recurring = false;
  bool _isProcessing = false;


  Future<void> _processPayment(Order order) async {
    setState(() => _isProcessing = true);
    try {
      // Simulate payment processing
      await Future.delayed(const Duration(seconds: 2));
      // Save order
      await ref.read(orderProvider.notifier).createOrder(order.copyWith(
        paymentMethod: _paymentMethod,
        isRecurring: _recurring,
        status: 'In Progress',
        createdAt: DateTime.now().toUtc(),
      ));
      if (mounted) {
        CustomDialogs.showSuccessDialog(
          context: context,
          title: AppLocalizations.of(context)!.success,
          content: AppLocalizations.of(context)!.paymentSuccess,
        ).then((_) {
          Navigator.pushReplacementNamed(
            context,
            NavigationService.orderTracking,
            arguments: order,
          );
        });
      }
    } catch (e) {
      if (mounted) {
        CustomDialogs.showErrorDialog(
          context: context,
          title: AppLocalizations.of(context)!.error,
          content: e.toString(),
        );
      }
    } finally {
      if (mounted) setState(() => _isProcessing = false);
    }
  }


  @override
  Widget build(BuildContext context) {
    final args = ModalRoute.of(context)!.settings.arguments as Order;
    final translations = AppLocalizations.of(context)!;


    return Scaffold(
      appBar: AppBar(
        title: Text(
          translations.payment,
          style: Theme.of(context).textTheme.titleLarge!.copyWith(
                fontWeight: FontWeight.w600,
              ),
        ),
        elevation: 0,
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      ),
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.all(8.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(
                constraints: const BoxConstraints(maxWidth: 500), // Limit content width
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.monetization_on_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.totalCost,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            Text(
                              '\$${args.details.totalCost.toStringAsFixed(2)}',
                              style: Theme.of(context).textTheme.bodyLarge!.copyWith(
                                    fontWeight: FontWeight.w600,
                                  ),
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.payment,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.paymentMethod,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8.0),
                            DropdownButtonFormField<String>(
                              value: _paymentMethod,
                              decoration: InputDecoration(
                                border: OutlineInputBorder(
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                filled: true,
                                fillColor: AppColors.lightGray.withOpacity(0.1),
                              ),
                              items: ['M-Pesa', 'Cash on Delivery', 'Credit Card']
                                  .map((method) => DropdownMenuItem(
                                        value: method,
                                        child: Text(method),
                                      ))
                                  .toList(),
                              onChanged: (value) {
                                if (value != null) {
                                  setState(() => _paymentMethod = value);
                                }
                              },
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8.0),
                    Card(
                      elevation: 2,
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                      child: Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Icon(
                                  Icons.repeat_outlined,
                                  color: Theme.of(context).colorScheme.primary,
                                  size: 20,
                                ),
                                const SizedBox(width: 8),
                                Text(
                                  translations.recurringOrder,
                                  style: Theme.of(context).textTheme.titleLarge!.copyWith(
                                        fontWeight: FontWeight.w600,
                                      ),
                                ),
                              ],
                            ),
                            CheckboxListTile(
                              value: _recurring,
                              onChanged: (value) {
                                setState(() => _recurring = value ?? false);
                              },
                              activeColor: Theme.of(context).colorScheme.primary,
                              title: null,
                              contentPadding: EdgeInsets.zero,
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 32.0),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        icon: _isProcessing
                            ? const SizedBox(
                                width: 20,
                                height: 20,
                                child: CircularProgressIndicator(
                                  color: Colors.white,
                                  strokeWidth: 2,
                                ),
                              )
                            : const Icon(Icons.payment),
                        label: Text(translations.payNow),
                        onPressed: _isProcessing ? null : () => _processPayment(args),
                        style: ElevatedButton.styleFrom(
                          minimumSize: const Size.fromHeight(52),
                          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          backgroundColor: Theme.of(context).colorScheme.primary,
                          foregroundColor: Colors.white,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/constants.dart';
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:amenities_kenya/utilities/dialogs.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class RatingScreen extends ConsumerStatefulWidget {
  const RatingScreen({super.key});


  @override
  _RatingScreenState createState() => _RatingScreenState();
}


class _RatingScreenState extends ConsumerState<RatingScreen> {
  int _rating = 0;
  final _commentController = TextEditingController();
  bool _isSubmitting = false;


  @override
  void dispose() {
    _commentController.dispose();
    super.dispose();
  }


  Future<void> _submitRating() async {
    if (_rating == 0) {
      CustomDialogs.showErrorDialog(
        context: context,
        title: AppLocalizations.of(context)!.error,
        content: 'Please select a rating.',
      );
      return;
    }


    setState(() => _isSubmitting = true);
    try {
      // Mock submission (replace with actual service call in production)
      await Future.delayed(const Duration(seconds: 1));
      if (mounted) {
        CustomDialogs.showSuccessDialog(
          context: context,
          title: AppLocalizations.of(context)!.success,
          content: AppLocalizations.of(context)!.ratingSuccess,
        ).then((_) => Navigator.popUntil(
              context,
              ModalRoute.withName(NavigationService.home),
            ));
      }
    } catch (e) {
      if (mounted) {
        CustomDialogs.showErrorDialog(
          context: context,
          title: AppLocalizations.of(context)!.error,
          content: e.toString(),
        );
      }
    } finally {
      if (mounted) setState(() => _isSubmitting = false);
    }
  }


  @override
  Widget build(BuildContext context) {
    final args = ModalRoute.of(context)!.settings.arguments as Order;
    final translations = AppLocalizations.of(context)!;


    return Scaffold(
      appBar: AppBar(title: Text(translations.rateSupplier)),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              translations.rating,
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 16.0),
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: List.generate(5, (index) {
                return IconButton(
                  icon: Icon(
                    index < _rating ? Icons.star : Icons.star_border,
                    color: AppColors.yellow,
                    size: 40.0,
                  ),
                  onPressed: () => setState(() => _rating = index + 1),
                );
              }),
            ),
            const SizedBox(height: 16.0),
            Text(
              translations.comment,
              style: Theme.of(context).textTheme.titleLarge,
            ),
            const SizedBox(height: 8.0),
            TextField(
              controller: _commentController,
              decoration: InputDecoration(
                hintText: translations.comment,
                border: const OutlineInputBorder(),
              ),
              maxLines: 4,
            ),
            const SizedBox(height: 24.0),
            ElevatedButton(
              onPressed: _isSubmitting ? null : _submitRating,
              child: _isSubmitting
                  ? const CircularProgressIndicator()
                  : Text(translations.submitRating),
            ),
          ],
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/providers/auth_provider.dart';
import 'package:amenities_kenya/screens/otp_verification_screen.dart';
import 'package:amenities_kenya/utilities/dialogs.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl_phone_field/intl_phone_field.dart';


class RegistrationScreen extends ConsumerStatefulWidget {
  const RegistrationScreen({super.key});


  @override
  _RegistrationScreenState createState() => _RegistrationScreenState();
}


class _RegistrationScreenState extends ConsumerState<RegistrationScreen> {
  final _formKey = GlobalKey<FormState>();
  String _phoneNumber = '';
  bool _isLoading = false;


  Future<void> _handleSendOtp() async {
    if (!_formKey.currentState!.validate()) return;


    setState(() => _isLoading = true);
    try {
      final otp = await ref.read(userProvider.notifier).sendOtp(_phoneNumber);
      if (mounted) {
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (context) => OtpVerificationScreen(
              phoneNumber: _phoneNumber,
              isRegistration: true,
            ),
          ),
        );
        CustomDialogs.showSuccessDialog(
          context: context,
          title: AppLocalizations.of(context)!.success,
          content: 'OTP sent: $otp', // For demo purposes
        );
      }
    } catch (e) {
      if (mounted) {
        CustomDialogs.showErrorDialog(
          context: context,
          title: AppLocalizations.of(context)!.error,
          content: e.toString(),
        );
      }
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }


  @override
  Widget build(BuildContext context) {
    final size = MediaQuery.of(context).size;
    final translations = AppLocalizations.of(context)!;
    final theme = Theme.of(context);


    return Scaffold(
      backgroundColor: Colors.white,
      body: SafeArea(
        child: LayoutBuilder(
          builder: (context, constraints) {
            return SingleChildScrollView(
              padding: const EdgeInsets.symmetric(horizontal: 24.0),
              child: ConstrainedBox(
                constraints: BoxConstraints(minHeight: constraints.maxHeight),
                child: IntrinsicHeight(
                  child: Form(
                    key: _formKey,
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        SizedBox(height: size.height * 0.1),
                        // Logo
                        Center(
                          child: Image.asset(
                            'assets/images/logo_amenities.png',
                            width: 150,
                            height: 150,
                            fit: BoxFit.contain,
                          ),
                        ),
                        const SizedBox(height: 32.0),
                        // Description
                        Text(
                          'Enter your phone number to create a new account.',
                          style: TextStyle(
                            fontSize: 16,
                            color: Colors.grey[600],
                          ),
                        ),
                        const SizedBox(height: 16.0),
                        // Phone Number Input
                        IntlPhoneField(
                          decoration: InputDecoration(
                            labelText: translations.phoneNumber,
                            filled: true,
                            fillColor: Colors.grey[200],
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(24.0),
                              borderSide: BorderSide.none,
                            ),
                            enabledBorder: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(24.0),
                              borderSide: BorderSide.none,
                            ),
                            focusedBorder: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(24.0),
                              borderSide: BorderSide(color: Colors.blue[900]!),
                            ),
                          ),
                          initialCountryCode: 'KE',
                          disableLengthCheck: true,
                          onChanged: (phone) {
                            _phoneNumber = phone.completeNumber;
                            print(phone.completeNumber);
                          },
                          validator: (phone) {
                            if (phone == null || phone.number.isEmpty) {
                              return translations.phoneRequired;
                            }
                            if (phone.number.length != 9) {
                              return 'Please enter a valid 9-digit number.';
                            }
                            return null;
                          },
                        ),
                        const Spacer(),
                        // Terms and Conditions
                        Text(
                          'By registering, you agree to our Terms of Service and Privacy Policy.',
                          textAlign: TextAlign.center,
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.grey[600],
                          ),
                        ),
                        const SizedBox(height: 16.0),
                        // Next Button
                        ElevatedButton(
                          onPressed: _isLoading ? null : _handleSendOtp,
                          style: ElevatedButton.styleFrom(
                            backgroundColor: Colors.blue[900],
                            foregroundColor: Colors.white,
                            minimumSize: const Size(double.infinity, 50),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(24.0),
                            ),
                            elevation: 0,
                          ),
                          child: _isLoading
                              ? const CircularProgressIndicator(
                                  color: Colors.white,
                                  strokeWidth: 2.0,
                                )
                              : Text(
                                  translations.sendOtp,
                                  style: const TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                        ),
                        const SizedBox(height: 16.0),
                        // Sign In Link
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Text(translations.alreadyHaveAccount),
                            TextButton(
                              onPressed: () => Navigator.pop(context),
                              child: Text(
                                translations.signIn,
                                style: const TextStyle(
                                  fontWeight: FontWeight.bold,
                                  fontSize: 16,
                                ),
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 24.0),
                      ],
                    ),
                  ),
                ),
              ),
            );
          },
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';


class SchedulingScreen extends ConsumerStatefulWidget {
  const SchedulingScreen({super.key});


  @override
  _SchedulingScreenState createState() => _SchedulingScreenState();
}


class _SchedulingScreenState extends ConsumerState<SchedulingScreen> {
  String _scheduleType = 'Immediate';
  DateTime? _selectedDateTime;
  String? _selectedDay;
  String? _selectedTime;
  int? _dayOfMonth;
  final _instructionsController = TextEditingController();


  @override
  void dispose() {
    _instructionsController.dispose();
    super.dispose();
  }


  @override
  Widget build(BuildContext context) {
    final args = ModalRoute.of(context)!.settings.arguments as Map<String, dynamic>;
    final supplier = args['supplier'] as Supplier;
    final orderDetails = args['orderDetails'] as OrderDetails;
    final deliveryAddress = args['deliveryAddress'] as String;
    final deliveryCoordinates = args['deliveryCoordinates'] as Coordinates;
    final translations = AppLocalizations.of(context)!;


    return Scaffold(
      appBar: AppBar(
        title: Text(
          translations.scheduleDelivery,
          style: Theme.of(context).textTheme.titleLarge!.copyWith(
                fontWeight: FontWeight.w600,
              ),
        ),
        elevation: 0,
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: SingleChildScrollView(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Card(
                elevation: 3,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                child: Padding(
                  padding: const EdgeInsets.all(16.0),
                  child: Container(
                    constraints: const BoxConstraints(maxWidth: 500), // Limit dropdown width
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            Icon(
                              Icons.schedule,
                              color: Theme.of(context).colorScheme.primary,
                              size: 24,
                            ),
                            const SizedBox(width: 8),
                            Text(
                              translations.scheduleDelivery,
                              style: Theme.of(context).textTheme.displayMedium!.copyWith(
                                    fontWeight: FontWeight.w700,
                                  ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 16.0),
                        DropdownButtonFormField<String>(
                          value: _scheduleType,
                          decoration: InputDecoration(
                            labelText: translations.scheduleType,
                            prefixIcon: const Icon(Icons.event, size: 20),
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                          items: [
                            'Immediate',
                            'Specific Date/Time',
                            'Weekly',
                            'Monthly',
                          ].map((type) => DropdownMenuItem(value: type, child: Text(type))).toList(),
                          onChanged: (value) => setState(() => _scheduleType = value!),
                        ),
                        const SizedBox(height: 16.0),
                        if (_scheduleType == 'Specific Date/Time') ...[
                          ElevatedButton.icon(
                            icon: const Icon(Icons.calendar_today_outlined, size: 20),
                            label: Text(
                              _selectedDateTime != null
                                  ? DateFormat('yyyy-MM-dd HH:mm').format(_selectedDateTime!)
                                  : translations.selectDateTime,
                              style: Theme.of(context).textTheme.bodyLarge,
                            ),
                            onPressed: () async {
                              final date = await showDatePicker(
                                context: context,
                                initialDate: DateTime.now(),
                                firstDate: DateTime.now(),
                                lastDate: DateTime.now().add(const Duration(days: 30)),
                              );
                              if (date != null) {
                                final time = await showTimePicker(
                                  context: context,
                                  initialTime: TimeOfDay.now(),
                                );
                                if (time != null) {
                                  setState(() {
                                    _selectedDateTime = DateTime(
                                      date.year,
                                      date.month,
                                      date.day,
                                      time.hour,
                                      time.minute,
                                    );
                                  });
                                }
                              }
                            },
                            style: ElevatedButton.styleFrom(
                              backgroundColor: Theme.of(context).colorScheme.surface,
                              foregroundColor: Theme.of(context).colorScheme.primary,
                              padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
                              shape: RoundedRectangleBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                              elevation: 1,
                              side: BorderSide(
                                color: Theme.of(context).colorScheme.primary.withOpacity(0.3),
                              ),
                            ),
                          ),
                        ],
                        if (_scheduleType == 'Weekly') ...[
                          const SizedBox(height: 16.0),
                          DropdownButtonFormField<String>(
                            value: _selectedDay,
                            decoration: InputDecoration(
                              labelText: translations.day,
                              prefixIcon: const Icon(Icons.calendar_view_week, size: 20),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            items: supplier.availability.days
                                .map((day) => DropdownMenuItem(value: day, child: Text(day)))
                                .toList(),
                            onChanged: (value) => setState(() => _selectedDay = value),
                          ),
                          const SizedBox(height: 16.0),
                          TextFormField(
                            initialValue: _selectedTime,
                            decoration: InputDecoration(
                              labelText: translations.time,
                              prefixIcon: const Icon(Icons.access_time_outlined, size: 20),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            onChanged: (value) => setState(() => _selectedTime = value),
                          ),
                        ],
                        if (_scheduleType == 'Monthly') ...[
                          const SizedBox(height: 16.0),
                          TextFormField(
                            initialValue: _dayOfMonth?.toString(),
                            keyboardType: TextInputType.number,
                            decoration: InputDecoration(
                              labelText: translations.dayOfMonth,
                              prefixIcon: const Icon(Icons.calendar_month_outlined, size: 20),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            onChanged: (value) => setState(() => _dayOfMonth = int.tryParse(value)),
                          ),
                          const SizedBox(height: 16.0),
                          TextFormField(
                            initialValue: _selectedTime,
                            decoration: InputDecoration(
                              labelText: translations.time,
                              prefixIcon: const Icon(Icons.access_time_outlined, size: 20),
                              border: OutlineInputBorder(
                                borderRadius: BorderRadius.circular(12),
                              ),
                            ),
                            onChanged: (value) => setState(() => _selectedTime = value),
                          ),
                        ],
                        const SizedBox(height: 16.0),
                        TextFormField(
                          controller: _instructionsController,
                          decoration: InputDecoration(
                            labelText: translations.instructions,
                            prefixIcon: const Icon(Icons.note_outlined, size: 20),
                            border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12),
                            ),
                          ),
                          maxLines: 3,
                        ),
                      ],
                    ),
                  ),
                ),
              ),
              const SizedBox(height: 24.0),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton.icon(
                  icon: const Icon(Icons.arrow_forward),
                  label: Text(translations.proceed),
                  onPressed: () {
                    final schedule = Schedule(
                      type: _scheduleType,
                      dateTime: _selectedDateTime?.toUtc().toIso8601String(),
                      day: _selectedDay,
                      time: _selectedTime,
                      dayOfMonth: _dayOfMonth,
                    );
                    Navigator.pushNamed(
                      context,
                      NavigationService.orderConfirmation,
                      arguments: {
                        'supplier': supplier,
                        'orderDetails': orderDetails,
                        'deliveryAddress': DeliveryAddress(
                          address: deliveryAddress,
                          coordinates: deliveryCoordinates,
                        ),
                        'schedule': schedule,
                        'instructions': _instructionsController.text,
                      },
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/constants.dart';
import 'package:amenities_kenya/providers/auth_provider.dart';
import 'package:amenities_kenya/services/preferences_service.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class SplashScreen extends ConsumerStatefulWidget {
  const SplashScreen({super.key});


  @override
  _SplashScreenState createState() => _SplashScreenState();
}


class _SplashScreenState extends ConsumerState<SplashScreen> {
  @override
  void initState() {
    super.initState();
    _navigateAfterDelay();
  }


  Future<void> _navigateAfterDelay() async {
    await Future.delayed(const Duration(seconds: 3));
    final prefs = ref.read(preferencesServiceProvider);
    final hasSeenOnboarding = await prefs.getHasSeenOnboarding();
    final user = ref.read(userProvider);


    if (!hasSeenOnboarding) {
      Navigator.pushReplacementNamed(context, NavigationService.onboarding);
    } else if (user == null) {
      Navigator.pushReplacementNamed(context, NavigationService.login);
    } else {
      Navigator.pushReplacementNamed(context, NavigationService.bottomNav);
    }
  }


  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white, // Set white background
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Image.asset(
              'assets/images/logo_amenities.png', // Use provided image
              width: 200, // Match original Lottie dimensions
              height: 200,
              fit: BoxFit.contain, // Ensure image scales properly
            ),
          ],
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/providers/auth_provider.dart';
import 'package:amenities_kenya/providers/supplier_provider.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:amenities_kenya/widgets/supplier_card.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class SupplierSelectionScreen extends ConsumerStatefulWidget {
  const SupplierSelectionScreen({super.key});


  @override
  _SupplierSelectionScreenState createState() => _SupplierSelectionScreenState();
}


class _SupplierSelectionScreenState extends ConsumerState<SupplierSelectionScreen> {
  String? _category;
  String? _address;
  Coordinates? _coordinates;
  String? _error;


  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    if (_category == null && mounted) {
      final args = ModalRoute.of(context)!.settings.arguments;
      if (args is Map<String, dynamic>) {
        _category = args['category'] as String?;
        _address = args['address'] as String?;
        _coordinates = args['coordinates'] as Coordinates?;
        if (_category != null && _address != null && _coordinates != null) {
          if (mounted) {
            ref.read(supplierProvider.notifier).fetchSuppliers(_category!);
          }
        } else {
          if (mounted) {
            setState(() {
              _error =
                  'Invalid arguments: Missing required fields (category, address, coordinates)';
            });
          }
        }
      } else {
        if (mounted) {
          setState(() {
            _error =
                'Invalid arguments: Expected Map<String, dynamic>, got ${args.runtimeType} (${args.toString()}). Check navigation call to SupplierSelectionScreen.';
          });
        }
      }
    }
  }


  @override
  Widget build(BuildContext context) {
    final translations = AppLocalizations.of(context)!;
    const Color primaryColor = Color(0xFF000048); // A dark, navy-like blue


    if (_error != null) {
      return Scaffold(
        appBar: AppBar(title: Text(translations.error)),
        body: Center(child: Text(_error!)),
      );
    }


    final supplierState = ref.watch(supplierProvider);


    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        elevation: 0,
        backgroundColor: Colors.white,
        leading: const IconButton(
          icon: Icon(Icons.menu, color: primaryColor, size: 30),
          onPressed: null, // TODO: Implement drawer opening
        ),
        title: Text(
          '${_category} near you',
          textAlign: TextAlign.center,
          style: const TextStyle(
            color: primaryColor,
            fontFamily: 'serif',
            fontWeight: FontWeight.w600,
            fontSize: 20,
            height: 1.2,
          ),
        ),
        centerTitle: true,
        actions: [
          PopupMenuButton<String>(
            icon: const Icon(Icons.sort, color: primaryColor, size: 30),
            onSelected: (value) {
              if (mounted) {
                ref.read(supplierProvider.notifier).setSortBy(value);
              }
            },
            itemBuilder: (context) => [
              PopupMenuItem(value: 'rating', child: Text(translations.sortByRating)),
              PopupMenuItem(value: 'distance', child: Text(translations.sortByDistance)),
            ],
          ),
          IconButton(
            icon: const Icon(Icons.arrow_back, color: primaryColor, size: 30),
            onPressed: () => Navigator.of(context).pop(),
          ),
          const SizedBox(width: 8),
        ],
      ),
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 20.0),
          child: Column(
            children: [
              _buildLocationBar(primaryColor),
              const SizedBox(height: 24),
              supplierState.when(
                data: (suppliers) => Column(
                  children: List.generate(
                    suppliers.length,
                    (index) {
                      final supplier = suppliers[index];
                      return SupplierCard(
                        supplier: supplier,
                        onTap: () {
                          if (mounted) {
                            Navigator.pushNamed(
                              context,
                              NavigationService.orderCustomization,
                              arguments: {
                                'supplier': supplier,
                                'address': _address,
                                'coordinates': _coordinates,
                              },
                            );
                          }
                        },
                      );
                    },
                  ),
                ),
                loading: () => const Center(child: CircularProgressIndicator()),
                error: (e, _) => Center(child: Text(e.toString())),
              ),
            ],
          ),
        ),
      ),
    );
  }


  Widget _buildLocationBar(Color iconColor) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 14),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(30.0),
        boxShadow: [
          BoxShadow(
            color: Colors.grey.withOpacity(0.15),
            spreadRadius: 2,
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Row(
        children: [
          Icon(Icons.edit_outlined, color: iconColor),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              _address ?? 'Loading location...',
              style: TextStyle(
                color: iconColor,
                fontWeight: FontWeight.bold,
                fontSize: 16,
              ),
              overflow: TextOverflow.ellipsis,
            ),
          ),
        ],
      ),
    );
  }
}
import 'package:amenities_kenya/models/supplier.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'package:geolocator/geolocator.dart';


class GoogleMapsService {
  final String apiKey;
  static const String _baseUrl = 'https://maps.googleapis.com/maps/api';


  GoogleMapsService(this.apiKey);


  Future<List<Map<String, dynamic>>> getPlaceSuggestions(String input) async {
    final encodedInput = Uri.encodeQueryComponent(input);
    final url = Uri.parse(
      '$_baseUrl/place/autocomplete/json?input=$encodedInput&key=$apiKey&components=country:ke&language=en',
    );
    try {
      final response = await http.get(url);
      if (response.statusCode == 200) {
        final json = jsonDecode(response.body);
        print('Autocomplete response: ${json['status']} - ${json['predictions']}');
        if (json['status'] == 'OK' || json['status'] == 'ZERO_RESULTS') {
          return List<Map<String, dynamic>>.from(json['predictions']);
        }
        throw Exception('Failed to fetch suggestions: ${json['status']} - ${json['error_message'] ?? ''}');
      }
      throw Exception('HTTP error: ${response.statusCode}');
    } catch (e) {
      print('Error in getPlaceSuggestions: $e');
      rethrow;
    }
  }


  Future<Map<String, dynamic>> getPlaceDetails(String placeId) async {
    final url = Uri.parse(
      '$_baseUrl/place/details/json?place_id=$placeId&fields=formatted_address,geometry&key=$apiKey&language=en',
    );
    try {
      final response = await http.get(url);
      if (response.statusCode == 200) {
        final json = jsonDecode(response.body);
        print('Place details response: ${json['status']}');
        if (json['status'] == 'OK') {
          return json['result'] as Map<String, dynamic>;
        }
        throw Exception('Failed to fetch place details: ${json['status']} - ${json['error_message'] ?? ''}');
      }
      throw Exception('HTTP error: ${response.statusCode}');
    } catch (e) {
      print('Error in getPlaceDetails: $e');
      rethrow;
    }
  }


  Future<String> getAddressFromCoordinates(double lat, double lon) async {
    final url = Uri.parse(
      '$_baseUrl/geocode/json?latlng=$lat,$lon&key=$apiKey&language=en',
    );
    try {
      final response = await http.get(url);
      if (response.statusCode == 200) {
        final json = jsonDecode(response.body);
        print('Geocode response: ${json['status']}');
        if (json['status'] == 'OK') {
          return json['results'][0]['formatted_address'] as String;
        }
        throw Exception('Failed to fetch address: ${json['status']} - ${json['error_message'] ?? ''}');
      }
      throw Exception('HTTP error: ${response.statusCode}');
    } catch (e) {
      print('Error in getAddressFromCoordinates: $e');
      rethrow;
    }
  }


  Future<Coordinates> getCurrentLocation() async {
    bool serviceEnabled;
    LocationPermission permission;


    try {
      serviceEnabled = await Geolocator.isLocationServiceEnabled();
      if (!serviceEnabled) {
        throw Exception('Location services are disabled.');
      }


      permission = await Geolocator.checkPermission();
      if (permission == LocationPermission.denied) {
        permission = await Geolocator.requestPermission();
        if (permission == LocationPermission.denied) {
          throw Exception('Location permissions are denied.');
        }
      }


      if (permission == LocationPermission.deniedForever) {
        throw Exception('Location permissions are permanently denied.');
      }


      final position = await Geolocator.getCurrentPosition(
        desiredAccuracy: LocationAccuracy.high,
      );
      return Coordinates(lat: position.latitude, lon: position.longitude);
    } catch (e) {
      print('Error in getCurrentLocation: $e');
      rethrow;
    }
  }
}
import 'dart:convert';
import 'package:flutter/services.dart';
import 'package:amenities_kenya/models/user.dart';
import 'package:uuid/uuid.dart';


class MockAuthService {
  Future<Map<String, dynamic>> _loadDb() async {
    try {
      final String jsonString = await rootBundle.loadString('assets/data/db.json');
      final decoded = json.decode(jsonString);
      if (decoded is Map) {
        return decoded.cast<String, dynamic>();
      } else {
        throw FormatException('Invalid JSON format: Expected a Map');
      }
    } catch (e) {
      throw Exception('Failed to load database: $e');
    }
  }


  Future<void> _saveDb(Map<String, dynamic> db) async {
    // In a real app, this would save to a backend
    // For mock purposes, we just simulate the operation
  }


  Future<String> sendOtp(String phoneNumber) async {
    // Validate phone number format
    if (!RegExp(r'^\+\d{9,12}$').hasMatch(phoneNumber)) {
      throw 'Invalid phone number format. Must be 9-12 digits.';
    }


    final db = await _loadDb();
    final users = db['users'] as List<dynamic>?;
    if (users == null) {
      throw Exception('Users list not found in database');
    }


    final userExists = users.any((user) => user['phone_number'] == phoneNumber);
   
    // if (userExists && phoneNumber != '+254734567890') { // Allow new users except for unverified
    //   throw 'Phone number already registered';
    // }
   
    // Generate a 6-digit OTP
    final otp = (100000 + (DateTime.now().millisecondsSinceEpoch % 900000)).toString();
   
    // Update or create user with OTP
    if (userExists) {
      final userIndex = users.indexWhere((user) => user['phone_number'] == phoneNumber);
      users[userIndex] = {
        ...users[userIndex] as Map,
        'otp': otp,
      };
    } else {
      users.add({
        'user_id': const Uuid().v4(),
        'phone_number': phoneNumber,
        'first_name': '',
        'last_name': '',
        'email': '',
        'username': '',
        'email_verified': false,
        'created_at': DateTime.now().toIso8601String(),
        'otp': otp,
      });
    }
   
    await _saveDb(db);
    return otp;
  }


  Future<User> verifyOtp(String phoneNumber, String otp) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>?;
    if (users == null) {
      throw Exception('Users list not found in database');
    }


    final user = users.firstWhere(
      (user) => user['phone_number'] == phoneNumber && user['otp'] == otp,
      orElse: () => null,
    );
   
    if (user == null) {
      throw 'Invalid OTP or phone number';
    }
   
    // Generate token
    final token = 'mock_jwt_token_for_$phoneNumber';
   
    // Update session
    final sessions = db['sessions'] as List<dynamic>?;
    if (sessions == null) {
      throw Exception('Sessions list not found in database');
    }


    sessions.add({
      'session_id': const Uuid().v4(),
      'user_id': user['user_id'],
      'token': token,
      'created_at': DateTime.now().toIso8601String(),
      'expires_at': DateTime.now().add(const Duration(days: 7)).toIso8601String(),
      'is_active': true,
    });
   
    // Clear OTP after successful verification
    user['otp'] = null;
   
    await _saveDb(db);
   
    return User.fromJson({
      ...user as Map,
      'token': token,
    });
  }


  Future<User> signUp({
    required String userId,
    required String phoneNumber,
    required String firstName,
    required String lastName,
    required String email,
    required String username,
  }) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>?;
    if (users == null) {
      throw Exception('Users list not found in database');
    }
   
    // Check for unique email and username
    if (users.any((user) => user['email'] == email)) {
      throw 'Email already registered';
    }
    if (users.any((user) => user['username'] == username)) {
      throw 'Username already taken';
    }
   
    final userIndex = users.indexWhere((user) => user['user_id'] == userId);
    if (userIndex == -1) {
      throw 'User not found';
    }
   
    users[userIndex] = {
      ...users[userIndex] as Map,
      'first_name': firstName,
      'last_name': lastName,
      'email': email,
      'username': username,
      'email_verified': false,
    };
   
    // Simulate sending email verification link
    print('Email verification link sent to $email');
   
    await _saveDb(db);
    return User.fromJson((users[userIndex]! as Map).cast<String, dynamic>());
  }


  Future<void> updateProfile({
    required String userId,
    required String firstName,
    required String lastName,
    required String email,
    required String phoneNumber,
  }) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>?;
    if (users == null) {
      throw Exception('Users list not found in database');
    }
   
    final userIndex = users.indexWhere((user) => user['user_id'] == userId);
    if (userIndex == -1) {
      throw 'User not found';
    }
   
    if (users.any((user) => user['email'] == email && user['user_id'] != userId)) {
      throw 'Email already registered';
    }
   
    users[userIndex] = {
      ...users[userIndex] as Map,
      'first_name': firstName,
      'last_name': lastName,
      'email': email,
      'phone_number': phoneNumber,
    };
   
    await _saveDb(db);
  }


  Future<void> verifyEmail(String userId, String verificationToken) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>?;
    if (users == null) {
      throw Exception('Users list not found in database');
    }
   
    final userIndex = users.indexWhere((user) => user['user_id'] == userId);
    if (userIndex == -1) {
      throw 'User not found';
    }
   
    // Simulate email verification
    users[userIndex]['email_verified'] = true;
    await _saveDb(db);
  }


  Future<void> logout(String userId) async {
    final db = await _loadDb();
    final sessions = db['sessions'] as List<dynamic>?;
    if (sessions == null) {
      throw Exception('Sessions list not found in database');
    }
   
    final sessionIndex = sessions.indexWhere((session) => session['user_id'] == userId && session['is_active']);
   
    if (sessionIndex != -1) {
      sessions[sessionIndex]['is_active'] = false;
      await _saveDb(db);
    }
  }
}
   Future<Map<String, dynamic>> _loadDb() async {
    try {
      final String jsonString = await rootBundle.loadString('assets/data/db.json');
      final decoded = json.decode(jsonString);
      if (decoded is Map) {
        return decoded.cast<String, dynamic>();
      } else {
        throw FormatException('Invalid JSON format: Expected a Map');
      }
    } catch (e) {
      throw Exception('Failed to load database: $e');
    }
  }
  Future<void> _saveDb(Map<String, dynamic> db) async {
    // In a real app, this would save to a backend
    // For mock purposes, we just simulate the operation
  }


  Future<String> sendOtp(String phoneNumber) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>;
    final userExists = users.any((user) => user['phone_number'] == phoneNumber);
   
    // if (userExists && phoneNumber != '+254734567890') { // Allow new users except for unverified
    //   throw 'Phone number already registered';
    // }
   
    // Generate a 6-digit OTP
    final otp = (100000 + (DateTime.now().millisecondsSinceEpoch % 900000)).toString();
   
    // Update or create user with OTP
    if (userExists) {
      final userIndex = users.indexWhere((user) => user['phone_number'] == phoneNumber);
      users[userIndex]['otp'] = otp;
    } else {
      users.add({
        'user_id': const Uuid().v4(),
        'phone_number': phoneNumber,
        'first_name': '',
        'last_name': '',
        'email': '',
        'username': '',
        'email_verified': false,
        'created_at': DateTime.now().toIso8601String(),
        'otp': otp,
      });
    }
   
    await _saveDb(db);
    return otp;
  }


  Future<User> verifyOtp(String phoneNumber, String otp) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>;
    final user = users.firstWhere(
      (user) => user['phone_number'] == phoneNumber && user['otp'] == otp,
      orElse: () => null,
    );
   
    if (user == null) {
      throw 'Invalid OTP or phone number';
    }
   
    // Generate token
    final token = 'mock_jwt_token_for_$phoneNumber';
   
    // Update session
    final sessions = db['sessions'] as List<dynamic>;
    sessions.add({
      'session_id': const Uuid().v4(),
      'user_id': user['user_id'],
      'token': token,
      'created_at': DateTime.now().toIso8601String(),
      'expires_at': DateTime.now().add(const Duration(days: 7)).toIso8601String(),
      'is_active': true,
    });
   
    // Clear OTP after successful verification
    user['otp'] = null;
   
    await _saveDb(db);
   
    return User.fromJson({
      ...user,
      'token': token,
    });
  }


  Future<User> signUp({
    required String userId,
    required String phoneNumber,
    required String firstName,
    required String lastName,
    required String email,
    required String username,
  }) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>;
   
    // Check for unique email and username
    if (users.any((user) => user['email'] == email)) {
      throw 'Email already registered';
    }
    if (users.any((user) => user['username'] == username)) {
      throw 'Username already taken';
    }
   
    final userIndex = users.indexWhere((user) => user['user_id'] == userId);
    if (userIndex == -1) {
      throw 'User not found';
    }
   
    users[userIndex] = {
      ...users[userIndex],
      'first_name': firstName,
      'last_name': lastName,
      'email': email,
      'username': username,
      'email_verified': false,
    };
   
    // Simulate sending email verification link
    // In a real app, this would send an email
    print('Email verification link sent to $email');
   
    await _saveDb(db);
    return User.fromJson(users[userIndex]);
  }


  Future<void> updateProfile({
    required String userId,
    required String firstName,
    required String lastName,
    required String email,
    required String phoneNumber,
  }) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>;
    final userIndex = users.indexWhere((user) => user['user_id'] == userId);
   
    if (userIndex == -1) {
      throw 'User not found';
    }
   
    if (users.any((user) => user['email'] == email && user['user_id'] != userId)) {
      throw 'Email already registered';
    }
   
    users[userIndex] = {
      ...users[userIndex],
      'first_name': firstName,
      'last_name': lastName,
      'email': email,
      'phone_number': phoneNumber,
    };
   
    await _saveDb(db);
  }


  Future<void> verifyEmail(String userId, String verificationToken) async {
    final db = await _loadDb();
    final users = db['users'] as List<dynamic>;
    final userIndex = users.indexWhere((user) => user['user_id'] == userId);
   
    if (userIndex == -1) {
      throw 'User not found';
    }
   
    // Simulate email verification
    users[userIndex]['email_verified'] = true;
    await _saveDb(db);
  }


  Future<void> logout(String userId) async {
    final db = await _loadDb();
    final sessions = db['sessions'] as List<dynamic>;
    final sessionIndex = sessions.indexWhere((session) => session['user_id'] == userId && session['is_active']);
   
    if (sessionIndex != -1) {
      sessions[sessionIndex]['is_active'] = false;
      await _saveDb(db);
    }
  }


import 'dart:convert';
import 'package:flutter/services.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:uuid/uuid.dart';


class MockOrderService {
  Future<List<Order>> getUserOrders(String userId) async {
    await Future.delayed(const Duration(milliseconds: 500));
    final jsonString = await rootBundle.loadString('assets/data/db.json');
    final db = json.decode(jsonString);
    final orders = db['orders'] as List;
    return orders
        .where((o) => o['user_id'] == userId)
        .map((o) => Order.fromJson(o))
        .toList();
  }


  Future<Order> createOrder(Order order) async {
    await Future.delayed(const Duration(milliseconds: 500));
    final newOrder = Order(
      orderId: const Uuid().v4(),
      userId: order.userId,
      supplierId: order.supplierId,
      category: order.category,
      details: order.details,
      deliveryAddress: order.deliveryAddress,
      schedule: order.schedule,
      instructions: order.instructions,
      status: 'In Progress',
      createdAt: DateTime.now().toUtc(),
      estimatedDeliveryTime: order.estimatedDeliveryTime,
    );
    return newOrder;
  }


   Future<void> placeOrder(Order order) async {
    // Simulate saving to db.json (in a real app, write to file or API)
    final jsonString = await rootBundle.loadString('assets/data/db.json');
    final db = json.decode(jsonString) as Map<String, dynamic>;
    final orders = db['orders'] as List;
    orders.add(order.toJson());
    // Note: This doesn't persist changes to assets/data/db.json
    // For persistence, use a local database or file system in a real app
  }
}


import 'dart:convert';
import 'package:flutter/services.dart';
import 'package:amenities_kenya/models/supplier.dart';


class MockSupplierService {
  Future<List<Supplier>> getSuppliersByCategory(String category) async {
    await Future.delayed(const Duration(milliseconds: 500));
    final jsonString = await rootBundle.loadString('assets/data/db.json');
    final db = json.decode(jsonString);
    final suppliers = db['suppliers'] as List;
    return suppliers
        .where((s) => s['category'] == category)
        .map((s) => Supplier.fromJson(s))
        .toList();
  }


  Future<Supplier> getSupplierById(String supplierId) async {
    final jsonString = await rootBundle.loadString('assets/data/db.json');
    final db = json.decode(jsonString);
    final suppliers = db['suppliers'] as List;
    final supplierJson = suppliers.firstWhere(
      (s) => s['supplier_id'] == supplierId,
      orElse: () => throw Exception('Supplier not found'),
    );
    return Supplier.fromJson(supplierJson);
  }
}
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:shared_preferences/shared_preferences.dart';


class PreferencesService {
  static const _hasSeenOnboardingKey = 'has_seen_onboarding';
  static const _themeKey = 'theme';
  static const _fontSizeKey = 'font_size';


  Future<void> setHasSeenOnboarding(bool value) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_hasSeenOnboardingKey, value);
  }


  Future<bool> getHasSeenOnboarding() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_hasSeenOnboardingKey) ?? false;
  }
 


  Future<String?> getTheme() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString(_themeKey);
  }


  Future<void> setTheme(String value) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_themeKey, value);
  }


  Future<double> getFontSize() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getDouble(_fontSizeKey) ?? 16.0;
  }


  Future<void> setFontSize(double value) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setDouble(_fontSizeKey, value);
  }
}


final preferencesServiceProvider = Provider<PreferencesService>((ref) {
  return PreferencesService();
});
import 'package:intl/intl.dart';


class DateFormatter {
  static String formatDateTime(DateTime dateTime) {
    final eatFormat = DateFormat('yyyy-MM-dd HH:mm', 'en_US');
    final eatTimeZone = DateTime.now()
        .toUtc()
        .add(const Duration(hours: 3)); // EAT is UTC+3
    return eatFormat.format(dateTime.toLocal());
  }


  static String formatDate(DateTime dateTime) {
    final eatFormat = DateFormat('yyyy-MM-dd', 'en_US');
    return eatFormat.format(dateTime.toLocal());
  }


  static String formatTime(DateTime dateTime) {
    final eatFormat = DateFormat('HH:mm', 'en_US');
    return eatFormat.format(dateTime.toLocal());
  }
}
import 'package:flutter/material.dart';


class CustomDialogs {
  static Future<bool> showConfirmationDialog({
    required BuildContext context,
    required String title,
    required String content,
    String confirmText = 'Confirm',
    String cancelText = 'Cancel',
  }) async {
    final result = await showDialog<bool>(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            const Icon(Icons.warning, color: Colors.orange, size: 28),
            const SizedBox(width: 12),
            Text(title, style: const TextStyle(fontSize: 20)),
          ],
        ),
        content: Text(content, style: const TextStyle(fontSize: 16)),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(
              cancelText,
              style: const TextStyle(fontSize: 16, color: Colors.grey),
            ),
          ),
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.orange,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
            onPressed: () => Navigator.pop(context, true),
            child: Text(
              confirmText,
              style: const TextStyle(fontSize: 16, color: Colors.white),
            ),
          ),
        ],
      ),
    );
    return result ?? false;
  }


  static Future<void> showSuccessDialog({
    required BuildContext context,
    required String title,
    required String content,
    String buttonText = 'OK',
  }) async {
    await showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            const Icon(Icons.check_circle, color: Colors.green, size: 28),
            const SizedBox(width: 12),
            Text(title, style: const TextStyle(fontSize: 20)),
          ],
        ),
        content: Text(content, style: const TextStyle(fontSize: 16)),
        actions: [
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.green,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
            onPressed: () => Navigator.of(context, rootNavigator: true).pop(),
            child: Text(
              buttonText,
              style: const TextStyle(fontSize: 16, color: Colors.white),
            ),
          ),
        ],
      ),
    );
  }


  static void showErrorDialog({
    required BuildContext context,
    required String title,
    required String content,
    String buttonText = 'OK',
    VoidCallback? onPressed,
  }) {
    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            const Icon(Icons.error, color: Colors.red, size: 28),
            const SizedBox(width: 12),
            Text(title, style: const TextStyle(fontSize: 20)),
          ],
        ),
        content: Text(content, style: const TextStyle(fontSize: 16)),
        actions: [
          ElevatedButton(
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(8),
              ),
            ),
            onPressed: () {
              Navigator.of(context).pop();
              onPressed?.call();
            },
            child: Text(
              buttonText,
              style: const TextStyle(fontSize: 16, color: Colors.white),
            ),
          ),
        ],
      ),
    );
  }
}
import 'dart:math';


class DistanceCalculator {
  static double calculateDistance(
      double lat1, double lon1, double lat2, double lon2) {
    const double earthRadius = 6371; // Radius of the earth in km
    final double dLat = _degreesToRadians(lat2 - lat1);
    final double dLon = _degreesToRadians(lon2 - lon1);


    final double a = sin(dLat / 2) * sin(dLat / 2) +
        cos(_degreesToRadians(lat1)) *
            cos(_degreesToRadians(lat2)) *
            sin(dLon / 2) *
            sin(dLon / 2);
    final double c = 2 * atan2(sqrt(a), sqrt(1 - a));
    final double distance = earthRadius * c; // Distance in km
    return distance;
  }


  static double _degreesToRadians(double degrees) {
    return degrees * pi / 180;
  }
}
import 'package:flutter/material.dart';


class NavigationService {
  static final GlobalKey<NavigatorState> navigatorKey =
      GlobalKey<NavigatorState>();


  static const String splash = '/splash';
  static const String onboarding = '/onboarding';
  static const String login = '/login';
  static const String bottomNav = '/bottomNav';
  static const String home = '/home';
  static const String pastOrders = '/pastOrders';
  static const String register = '/register';
  static const String profileSetup = '/profileSetup';
  static const String locationInput = '/locationInput';
  static const String supplierSelection = '/supplierSelection';
  static const String orderCustomization = '/orderCustomization';
  static const String scheduling = '/scheduling';
  static const String orderConfirmation = '/orderConfirmation';
  static const String orderSummary = '/orderSummary';
  static const String payment = '/payment';
  static const String orderTracking = '/orderTracking';
  static const String rateSupplier = '/rateSupplier';
  static const String settings = '/settings';
  static const String profile = '/profile';


  static Future<dynamic> pushNamed(String routeName, {Object? arguments}) {
    return navigatorKey.currentState!
        .pushNamed(routeName, arguments: arguments);
  }


  static Future<dynamic> pushReplacementNamed(String routeName,
      {Object? arguments}) {
    return navigatorKey.currentState!
        .pushReplacementNamed(routeName, arguments: arguments);
  }


  static void pop() {
    navigatorKey.currentState!.pop();
  }
}
import 'package:amenities_kenya/constants.dart';
import 'package:flutter/material.dart';


class CategoryCard extends StatelessWidget {
  final String category;
  final VoidCallback onTap;


  const CategoryCard({
    super.key,
    required this.category,
    required this.onTap,
  });


  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Card(
        elevation: 4.0,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12.0),
        ),
        child: Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(12.0),
            gradient: LinearGradient(
              colors: [
                AppColors.lightPrimary,
                AppColors.lightPrimary.withOpacity(0.7),
              ],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
          ),
          child: Center(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Text(
                category,
                style: Theme.of(context).textTheme.titleLarge?.copyWith(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                    ),
                textAlign: TextAlign.center,
              ),
            ),
          ),
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:flutter/material.dart';


class ErrorWidget extends StatelessWidget {
  final String errorMessage;
  final VoidCallback? onRetry;


  const ErrorWidget({
    super.key,
    required this.errorMessage,
    this.onRetry,
  });


  @override
  Widget build(BuildContext context) {
    final translations = AppLocalizations.of(context)!;


    return Center(
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(Icons.error_outline, size: 60, color: Colors.red),
            const SizedBox(height: 16.0),
            Text(
              translations.error,
              style: Theme.of(context).textTheme.displayMedium,
            ),
            const SizedBox(height: 8.0),
            Text(
              errorMessage,
              style: Theme.of(context).textTheme.bodyLarge,
              textAlign: TextAlign.center,
            ),
            if (onRetry != null) ...[
              const SizedBox(height: 16.0),
              ElevatedButton(
                onPressed: onRetry,
                child: Text(translations.retry),
              ),
            ],
          ],
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/constants.dart';
import 'package:flutter/material.dart';
import 'package:flutter_spinkit/flutter_spinkit.dart';


class LoadingWidget extends StatelessWidget {
  const LoadingWidget({super.key});


  @override
  Widget build(BuildContext context) {
    return Center(
      child: SpinKitWave(
        color: AppColors.lightPrimary,
        size: 50.0,
      ),
    );
  }
}
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/order.dart';
import 'package:flutter/material.dart';


class OrderItemWidget extends StatelessWidget {
  final OrderDetails details;
  final String category;


  const OrderItemWidget({
    super.key,
    required this.details,
    required this.category,
  });


  @override
  Widget build(BuildContext context) {
    final translations = AppLocalizations.of(context)!;


    return Card(
      elevation: 2.0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(8.0),
      ),
      child: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              category,
              style: Theme.of(context).textTheme.titleMedium,
            ),
            const SizedBox(height: 8.0),
            if (details.liters != null) ...[
              Text(
                '${translations.liters}: ${details.liters} @ \$${details.pricePerLiter?.toStringAsFixed(2)}/L',
              ),
            ],
            if (details.item != null) ...[
              Text(
                '${translations.item}: ${details.item!.type}',
              ),
              if (details.item!.brand != null)
                Text('${translations.brand}: ${details.item!.brand}'),
              if (details.item!.size != null)
                Text('${translations.size}: ${details.item!.size}'),
              if (details.item!.name != null)
                Text('${translations.accessory}: ${details.item!.name}'),
              Text(
                '${translations.quantity}: ${details.item!.quantity}',
              ),
              Text(
                '${translations.price}: \$${details.item!.price.toStringAsFixed(2)}',
              ),
            ],
            if (details.type != null) ...[
              Text('${translations.type}: ${details.type}'),
              if (details.bags != null)
                Text('${translations.bags}: ${details.bags}'),
              if (details.basePrice != null)
                Text(
                  '${translations.basePrice}: \$${details.basePrice!.toStringAsFixed(2)}',
                ),
              if (details.additionalBags != null)
                Text(
                  '${translations.additionalBags}: ${details.additionalBags} @ \$${details.additionalBagPrice?.toStringAsFixed(2)}',
                ),
              if (details.pricePerBag != null)
                Text(
                  '${translations.pricePerBag}: \$${details.pricePerBag!.toStringAsFixed(2)}',
                ),
            ],
            if (details.trips != null) ...[
              Text('${translations.trips}: ${details.trips}'),
              if (details.pricePerTrip != null)
                Text(
                  '${translations.pricePerTrip}: \$${details.pricePerTrip!.toStringAsFixed(2)}',
                ),
            ],
            const SizedBox(height: 8.0),
            Text(
              '${translations.deliveryFee}: \$${details.deliveryFee.toStringAsFixed(2)}',
            ),
            Text(
              '${translations.totalCost}: \$${details.totalCost.toStringAsFixed(2)}',
              style: Theme.of(context).textTheme.bodyLarge,
            ),
          ],
        ),
      ),
    );
  }
}
import 'package:amenities_kenya/constants.dart';
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/models/supplier.dart';
import 'package:amenities_kenya/providers/location_provider.dart';
import 'package:amenities_kenya/utilities/distance_calculator.dart';
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


class SupplierCard extends ConsumerWidget {
  final Supplier supplier;
  final VoidCallback onTap;


  const SupplierCard({
    super.key,
    required this.supplier,
    required this.onTap,
  });


  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final translations = AppLocalizations.of(context)!;
    final location = ref.watch(locationProvider);
        final screenWidth = MediaQuery.of(context).size.width;




    double? distance;
    location.whenData((coords) {
      distance = DistanceCalculator.calculateDistance(
        coords.lat,
        coords.lon,
        supplier.coordinates.lat,
        supplier.coordinates.lon,
      );
    });


   return Card(
      elevation: 4.0,
      margin: const EdgeInsets.symmetric(vertical: 8.0),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12.0),
      ),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12.0),
        child: Padding(
          padding: const EdgeInsets.all(16.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Image: Full container width
              ClipRRect(
                borderRadius: BorderRadius.circular(8.0),
                child: Image.asset(
                  'assets/images/supplierimage.png',
                  width: double.infinity, // Span full container width
                  height: screenWidth * 3 / 8, // Maintain height from previous request
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) => Container(
                    width: double.infinity,
                    height: screenWidth * 3 / 8,
                    color: AppColors.lightGray,
                    child: const Icon(Icons.image_not_supported),
                  ),
                ),
              ),
              const SizedBox(height: 8.0),
              // Supplier Name
              Text(
                supplier.name,
                style: Theme.of(context).textTheme.titleLarge,
                overflow: TextOverflow.ellipsis,
              ),
              const SizedBox(height: 4.0),
              // Address
              Text(
                supplier.address,
                style: Theme.of(context).textTheme.bodyMedium,
                overflow: TextOverflow.ellipsis,
              ),
              const SizedBox(height: 4.0),
              // Rating and Distance
              Row(
                children: [
                  Icon(Icons.star, color: AppColors.yellow, size: 20.0),
                  const SizedBox(width: 4.0),
                  Text(
                    '${supplier.averageRating.toStringAsFixed(1)} (${supplier.reviewCount} ${translations.reviews})',
                    style: Theme.of(context).textTheme.bodyMedium,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const Spacer(),
                  if (distance != null)
                    Text(
                      '${distance!.toStringAsFixed(1)} km',
                      style: Theme.of(context).textTheme.bodyMedium,
                      overflow: TextOverflow.ellipsis,
                    ),
                ],
              ),
              // Promotion
              if (supplier.promotions.isNotEmpty) ...[
                const SizedBox(height: 8.0),
                Text(
                  '${translations.promotion}: ${supplier.promotions.first.description}',
                  style: Theme.of(context)
                      .textTheme
                      .bodySmall
                      ?.copyWith(color: AppColors.lightPrimary),
                  overflow: TextOverflow.ellipsis,
                ),
              ],
            ],
          ),
        ),
      ),
    );
  }
}
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';


class AppColors {
  static const Color bluePrimary = Color(0xFF1E88E5); // Vibrant professional blue
  static const Color blueSecondary = Color(0xFF64B5F6); // Lighter blue for gradients
  static const Color lightBackground = Color(0xFFF5F7FA); // Soft off-white
  static const Color darkBackground = Color(0xFF121212); // Dark gray for dark mode
  static const Color lightSurface = Color(0xFFFFFFFF); // White for cards
  static const Color darkSurface = Color(0xFF1E1E1E); // Darker gray for cards
  static const Color lightError = Color(0xFFE57373); // Soft red for errors
  static const Color darkError = Color(0xFFEF5350); // Brighter red for dark mode
  static const Color grey = Color(0xFF78909C); // Neutral gray
  static const Color lightOnPrimary = Colors.black; // Black text for light theme
  static const Color darkOnPrimary = Color(0xFFE0E0E0); // Light gray for dark theme
}


class AppThemes {
  static final ThemeData lightTheme = ThemeData(
    brightness: Brightness.light,
    colorScheme: const ColorScheme.light(
      primary: AppColors.bluePrimary,
      secondary: AppColors.blueSecondary,
      surface: AppColors.lightSurface,
      error: AppColors.lightError,
      onPrimary: AppColors.lightOnPrimary,
      onSecondary: AppColors.lightOnPrimary,
      onSurface: AppColors.lightOnPrimary,
      onError: Colors.white,
    ),
    scaffoldBackgroundColor: AppColors.lightBackground,
    dividerColor: AppColors.grey.withOpacity(0.3),
    appBarTheme: AppBarTheme(
      backgroundColor: AppColors.lightBackground, // Fallback to solid color
      scrolledUnderElevation: 0,
      elevation: 0,
      centerTitle: true,
      titleTextStyle: GoogleFonts.poppins(
        color: AppColors.lightOnPrimary,
        fontSize: 20.0,
        fontWeight: FontWeight.w600,
      ),
      // iconTheme: const IconThemeData(color: AppColors.lightOnPrimary),
      iconTheme: const IconThemeData(color: AppColors.lightOnPrimary),
    ),
    elevatedButtonTheme: ElevatedButtonThemeData(
      style: ElevatedButton.styleFrom(
        foregroundColor: AppColors.lightOnPrimary,
        backgroundColor: AppColors.bluePrimary, // Fallback solid color
        shadowColor: AppColors.bluePrimary.withOpacity(0.3),
        textStyle: GoogleFonts.cabin(
          fontSize: 16.0,
          fontWeight: FontWeight.w600,
        ),
        padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        elevation: 5,
        surfaceTintColor: Colors.transparent,
        minimumSize: const Size(120, 56), // Adjusted for onboarding screen
        disabledBackgroundColor: AppColors.grey.withOpacity(0.5),
      ).copyWith(
        overlayColor: MaterialStateProperty.all(AppColors.blueSecondary.withOpacity(0.1)),
      ),
    ),
    textButtonTheme: TextButtonThemeData(
      style: TextButton.styleFrom(
        foregroundColor: AppColors.bluePrimary,
        textStyle: GoogleFonts.cabin(
          fontSize: 16.0,
          fontWeight: FontWeight.w600,
        ),
        padding: const EdgeInsets.symmetric(horizontal: 16),
      ),
    ),
    cardTheme: CardThemeData(
      color: AppColors.lightSurface,
      shadowColor: AppColors.bluePrimary.withOpacity(0.3),
      elevation: 5,
      margin: const EdgeInsets.all(12.0),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
    ),
    listTileTheme: ListTileThemeData(
      contentPadding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),
      iconColor: AppColors.bluePrimary,
      textColor: AppColors.lightOnPrimary,
      tileColor: AppColors.lightSurface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
    ),
    bottomNavigationBarTheme: BottomNavigationBarThemeData(
      type: BottomNavigationBarType.fixed,
      backgroundColor: AppColors.lightBackground,
      selectedItemColor: AppColors.bluePrimary,
      unselectedItemColor: AppColors.grey,
      elevation: 2,
      selectedLabelStyle: GoogleFonts.cabin(fontWeight: FontWeight.w600),
      unselectedLabelStyle: GoogleFonts.cabin(fontWeight: FontWeight.w400),
    ),
    textTheme: TextTheme(
      displayLarge: GoogleFonts.poppins(
        color: AppColors.lightOnPrimary,
        fontSize: 26.0,
        fontWeight: FontWeight.w700,
      ),
      displayMedium: GoogleFonts.poppins(
        color: AppColors.lightOnPrimary,
        fontSize: 22.0,
        fontWeight: FontWeight.w600,
      ),
      titleLarge: GoogleFonts.poppins(
        color: AppColors.lightOnPrimary,
        fontSize: 18.0,
        fontWeight: FontWeight.w600,
      ),
      bodyLarge: GoogleFonts.cabin(
        color: AppColors.lightOnPrimary,
        fontSize: 16.0,
        fontWeight: FontWeight.w400,
      ),
      bodyMedium: GoogleFonts.cabin(
        color: AppColors.lightOnPrimary,
        fontSize: 14.0,
        fontWeight: FontWeight.w400,
      ),
      labelLarge: GoogleFonts.cabin(
        color: AppColors.lightOnPrimary,
        fontSize: 16.0,
        fontWeight: FontWeight.w600,
      ),
    ),
    inputDecorationTheme: InputDecorationTheme(
      filled: true,
      fillColor: AppColors.lightSurface.withOpacity(0.9),
      hintStyle: GoogleFonts.cabin(color: AppColors.grey),
      labelStyle: GoogleFonts.cabin(color: AppColors.lightOnPrimary),
      errorStyle: GoogleFonts.cabin(color: AppColors.lightError),
      contentPadding: const EdgeInsets.symmetric(vertical: 16, horizontal: 16),
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide.none,
      ),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide.none,
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: AppColors.bluePrimary, width: 2.0),
      ),
      errorBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: AppColors.lightError),
      ),
      focusedErrorBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: AppColors.lightError, width: 2.0),
      ),
    ),
    dialogTheme: DialogThemeData(
      backgroundColor: AppColors.lightSurface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      titleTextStyle: GoogleFonts.poppins(
        color: AppColors.lightOnPrimary,
        fontSize: 20,
        fontWeight: FontWeight.w600,
      ),
      contentTextStyle: GoogleFonts.cabin(
        color: AppColors.lightOnPrimary,
        fontSize: 16,
      ),
    ),
  );


  static final ThemeData darkTheme = ThemeData(
    brightness: Brightness.dark,
    colorScheme: const ColorScheme.dark(
      primary: AppColors.bluePrimary,
      secondary: AppColors.blueSecondary,
      surface: AppColors.darkSurface,
      error: AppColors.darkError,
      onPrimary: AppColors.darkOnPrimary,
      onSecondary: AppColors.darkOnPrimary,
      onSurface: AppColors.darkOnPrimary,
      onError: Colors.white,
    ),
    scaffoldBackgroundColor: AppColors.darkBackground,
    dividerColor: AppColors.grey.withOpacity(0.3),
    appBarTheme: AppBarTheme(
      backgroundColor: AppColors.darkBackground, // Fallback to solid color
      scrolledUnderElevation: 0,
      elevation: 0,
      centerTitle: true,
      titleTextStyle: GoogleFonts.poppins(
        color: AppColors.darkOnPrimary,
        fontSize: 20.0,
        fontWeight: FontWeight.w600,
      ),
      iconTheme: const IconThemeData(color: AppColors.darkOnPrimary),
    ),
    elevatedButtonTheme: ElevatedButtonThemeData(
      style: ElevatedButton.styleFrom(
        foregroundColor: AppColors.darkOnPrimary,
        backgroundColor: AppColors.bluePrimary, // Fallback solid color
        shadowColor: AppColors.bluePrimary.withOpacity(0.4),
        textStyle: GoogleFonts.cabin(
          fontSize: 16.0,
          fontWeight: FontWeight.w600,
        ),
        padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 24),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
        elevation: 5,
        surfaceTintColor: Colors.transparent,
        minimumSize: const Size(120, 56), // Adjusted for onboarding screen
        disabledBackgroundColor: AppColors.grey.withOpacity(0.5),
      ).copyWith(
        overlayColor: MaterialStateProperty.all(AppColors.blueSecondary.withOpacity(0.1)),
      ),
    ),
    textButtonTheme: TextButtonThemeData(
      style: TextButton.styleFrom(
        foregroundColor: AppColors.bluePrimary,
        textStyle: GoogleFonts.cabin(
          fontSize: 16.0,
          fontWeight: FontWeight.w600,
        ),
        padding: const EdgeInsets.symmetric(horizontal: 16),
      ),
    ),
    cardTheme: CardThemeData(
      color: AppColors.darkSurface,
      shadowColor: AppColors.bluePrimary.withOpacity(0.4),
      elevation: 5,
      margin: const EdgeInsets.all(12.0),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
    ),
    listTileTheme: ListTileThemeData(
      contentPadding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),
      iconColor: AppColors.bluePrimary,
      textColor: AppColors.darkOnPrimary,
      tileColor: AppColors.darkSurface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
    ),
    bottomNavigationBarTheme: BottomNavigationBarThemeData(
      type: BottomNavigationBarType.fixed,
      backgroundColor: AppColors.darkBackground,
      selectedItemColor: AppColors.bluePrimary,
      unselectedItemColor: AppColors.grey,
      elevation: 2,
      selectedLabelStyle: GoogleFonts.cabin(fontWeight: FontWeight.w600),
      unselectedLabelStyle: GoogleFonts.cabin(fontWeight: FontWeight.w400),
    ),
    textTheme: TextTheme(
      displayLarge: GoogleFonts.poppins(
        color: AppColors.darkOnPrimary,
        fontSize: 26.0,
        fontWeight: FontWeight.w700,
      ),
      displayMedium: GoogleFonts.poppins(
        color: AppColors.darkOnPrimary,
        fontSize: 22.0,
        fontWeight: FontWeight.w600,
      ),
      titleLarge: GoogleFonts.poppins(
        color: AppColors.darkOnPrimary,
        fontSize: 18.0,
        fontWeight: FontWeight.w600,
      ),
      bodyLarge: GoogleFonts.cabin(
        color: AppColors.darkOnPrimary,
        fontSize: 16.0,
        fontWeight: FontWeight.w400,
      ),
      bodyMedium: GoogleFonts.cabin(
        color: AppColors.darkOnPrimary,
        fontSize: 14.0,
        fontWeight: FontWeight.w400,
      ),
      labelLarge: GoogleFonts.cabin(
        color: AppColors.darkOnPrimary,
        fontSize: 16.0,
        fontWeight: FontWeight.w600,
      ),
    ),
    inputDecorationTheme: InputDecorationTheme(
      filled: true,
      fillColor: AppColors.darkSurface.withOpacity(0.9),
      hintStyle: GoogleFonts.cabin(color: AppColors.grey),
      labelStyle: GoogleFonts.cabin(color: AppColors.darkOnPrimary),
      errorStyle: GoogleFonts.cabin(color: AppColors.darkError),
      contentPadding: const EdgeInsets.symmetric(vertical: 16, horizontal: 16),
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide.none,
      ),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide.none,
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: AppColors.bluePrimary, width: 2.0),
      ),
      errorBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: AppColors.darkError),
      ),
      focusedErrorBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: AppColors.darkError, width: 2.0),
      ),
    ),
    dialogTheme: DialogThemeData(
      backgroundColor: AppColors.darkSurface,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      titleTextStyle: GoogleFonts.poppins(
        color: AppColors.darkOnPrimary,
        fontSize: 20,
        fontWeight: FontWeight.w600,
      ),
      contentTextStyle: GoogleFonts.cabin(
        color: AppColors.darkOnPrimary,
        fontSize: 16,
      ),
    ),
  );
}
import 'package:flutter/material.dart';


class AppColors {
  static const Color lightPrimary = Color(0xFF1976D2); // Blue
  static const Color lightSecondary = Color(0xFF64B5F6); // Light Blue
  static const Color lightSurface = Color(0xFFFFFFFF); // White
  static const Color lightError = Color(0xFFD32F2F); // Red
  static const Color lightOnPrimary = Color(0xFFFFFFFF); // White
  static const Color lightOnSecondary = Color(0xFF000000); // Black
  static const Color lightOnSurface = Color(0xFF000000); // Black
  static const Color lightOnError = Color(0xFFFFFFFF); // White
  static const Color lightBackground = Color(0xFFF5F5F5); // Off-White
  static const Color dividerColor = Color(0xFFB0BEC5); // Grey
  static const Color grey = Color(0xFF757575);
  static const Color yellow = Color(0xFFFFC107); // Amber
  static const Color lightGray = Color(0xFFE0E0E0); // Light Grey
  static const Color green = Color(0xFF4CAF50); // Green for success


  static const Color darkPrimary = Color(0xFF42A5F5); // Lighter Blue
  static const Color darkSecondary = Color(0xFF90CAF9); // Light Blue
  static const Color darkSurface = Color(0xFF212121); // Dark Grey
  static const Color darkError = Color(0xFFEF5350); // Red
  static const Color darkOnPrimary = Color(0xFF000000); // Black
  static const Color darkOnSecondary = Color(0xFF000000); // Black
  static const Color darkOnSurface = Color(0xFFFFFFFF); // White
  static const Color darkOnError = Color(0xFF000000); // Black
  static const Color darkBackground = Color(0xFF121212); // Dark
}
import 'package:amenities_kenya/app_themes.dart';
import 'package:amenities_kenya/l10n/app_localizations.dart';
import 'package:amenities_kenya/providers/locale_provider.dart';
import 'package:amenities_kenya/providers/theme_provider.dart';
import 'package:amenities_kenya/screens/bottom_navigation_screen.dart';
import 'package:amenities_kenya/screens/home_screen.dart';
import 'package:amenities_kenya/screens/location_input_screen.dart';
import 'package:amenities_kenya/screens/login_screen.dart';
import 'package:amenities_kenya/screens/onboarding_screen.dart';
import 'package:amenities_kenya/screens/order_confirmation_screen.dart';
import 'package:amenities_kenya/screens/order_customization_screen.dart';
import 'package:amenities_kenya/screens/order_summary_screen.dart';
import 'package:amenities_kenya/screens/order_tracking_screen.dart';
import 'package:amenities_kenya/screens/past_orders_screen.dart';
import 'package:amenities_kenya/screens/payment_screen.dart';
import 'package:amenities_kenya/screens/profile_screen.dart';
import 'package:amenities_kenya/screens/profile_setup_screen.dart';
import 'package:amenities_kenya/screens/rating_screen.dart';
import 'package:amenities_kenya/screens/registration_screen.dart';
import 'package:amenities_kenya/screens/scheduling_screen.dart';
import 'package:amenities_kenya/screens/settings_screen.dart';
import 'package:amenities_kenya/screens/splash_screen.dart';
import 'package:amenities_kenya/screens/supplier_selection_screen.dart';
import 'package:amenities_kenya/services/preferences_service.dart';
import 'package:amenities_kenya/utilities/navigation_service.dart';
import 'package:flutter/material.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';


void main() {
  runApp(const ProviderScope(child: MyApp()));
}


class MyApp extends ConsumerStatefulWidget {
  const MyApp({super.key});


  @override
  ConsumerState<MyApp> createState() => _MyAppState();
}


class _MyAppState extends ConsumerState<MyApp> {
  @override
  Widget build(BuildContext context) {
    final locale = ref.watch(localeProvider);
    final themeMode = ref.watch(themeProvider);
    final preferencesService = ref.watch(preferencesServiceProvider);


    return FutureBuilder<double>(
      future: preferencesService.getFontSize(),
      builder: (context, snapshot) {
        final fontSize = snapshot.data ?? 16.0;
        return MaterialApp(
          title: 'Amenity Service Platform',
          theme: AppThemes.lightTheme.copyWith(
            textTheme: AppThemes.lightTheme.textTheme.apply(
              fontSizeFactor: fontSize / 16.0,
            ),
          ),
          darkTheme: AppThemes.darkTheme.copyWith(
            textTheme: AppThemes.darkTheme.textTheme.apply(
              fontSizeFactor: fontSize / 16.0,
            ),
          ),
          themeMode: themeMode,
          locale: locale,
          localizationsDelegates: const [
            AppLocalizations.delegate,
            GlobalMaterialLocalizations.delegate,
            GlobalWidgetsLocalizations.delegate,
            GlobalCupertinoLocalizations.delegate,
          ],
          supportedLocales: const [
            Locale('en'),
            Locale('sw'),
          ],
          navigatorKey: NavigationService.navigatorKey,
          initialRoute: NavigationService.splash,
          routes: {
            NavigationService.splash: (context) => const SplashScreen(),
            NavigationService.profile: (context) => const ProfileScreen(),
            NavigationService.onboarding: (context) => const OnboardingScreen(),
            NavigationService.login: (context) => const LoginScreen(),
            NavigationService.home: (context) => const HomeScreen(),
            NavigationService.bottomNav: (context) => const BottomNavigationScreen(),
            NavigationService.supplierSelection: (context) =>
                const SupplierSelectionScreen(),
            NavigationService.orderCustomization: (context) =>
                const OrderCustomizationScreen(),
            NavigationService.scheduling: (context) => const SchedulingScreen(),
            NavigationService.orderConfirmation: (context) =>
                const OrderConfirmationScreen(),
            NavigationService.orderSummary: (context) => const OrderSummaryScreen(),
            NavigationService.payment: (context) => const PaymentScreen(),
            NavigationService.orderTracking: (context) => const OrderTrackingScreen(),
            NavigationService.rateSupplier: (context) => const RatingScreen(),
            NavigationService.pastOrders: (context) => const PastOrdersScreen(),
            NavigationService.register: (context) => const RegistrationScreen(),
            NavigationService.profileSetup: (context) => ProfileSetupScreen(
                  phoneNumber:
                      (ModalRoute.of(context)!.settings.arguments as Map)['phoneNumber'],
                ),
            NavigationService.locationInput: (context) => LocationInputScreen(
                  category: (ModalRoute.of(context)!.settings.arguments
                          as Map<String, dynamic>?)?['category'] ??
                      '',
                ),
            NavigationService.settings: (context) => const SettingsScreen(),
          },
        );
      },
    );
  }
}
name: amenities_kenya
description: "A new Flutter project."
# The following line prevents the package from being accidentally published to
# pub.dev using `flutter pub publish`. This is preferred for private packages.
publish_to: 'none' # Remove this line if you wish to publish to pub.dev


# The following defines the version and build number for your application.
# A version number is three numbers separated by dots, like 1.2.43
# followed by an optional build number separated by a +.
# Both the version and the builder number may be overridden in flutter
# build by specifying --build-name and --build-number, respectively.
# In Android, build-name is used as versionName while build-number used as versionCode.
# Read more about Android versioning at https://developer.android.com/studio/publish/versioning
# In iOS, build-name is used as CFBundleShortVersionString while build-number is used as CFBundleVersion.
# Read more about iOS versioning at
# https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html
# In Windows, build-name is used as the major, minor, and patch parts
# of the product and file versions while build-number is used as the build suffix.
version: 1.0.0+1


environment:
  sdk: ^3.8.1


# Dependencies specify other packages that your package needs in order to work.
# To automatically upgrade your package dependencies to the latest versions
# consider running `flutter pub upgrade --major-versions`. Alternatively,
# dependencies can be manually updated by changing the version numbers below to
# the latest version available on pub.dev. To see which dependencies have newer
# versions available, run `flutter pub outdated`.
dependencies:
  flutter:
    sdk: flutter


  # The following adds the Cupertino Icons font to your application.
  # Use with the CupertinoIcons class for iOS style icons.
  cupertino_icons: ^1.0.8
  flutter_riverpod: ^2.6.1
  dio: ^5.8.0+1
  shared_preferences: ^2.5.3
  dots_indicator: ^4.0.1
  google_fonts: ^6.2.1
  flutter_localization: ^0.3.2
  flutter_localizations:
    sdk: flutter
  animated_splash_screen: ^1.3.0
  lottie: ^3.3.1
  intl: ^0.20.2
  uuid: ^4.5.1
  http: ^1.4.0
  flutter_spinkit: ^5.2.1
  pin_code_fields: ^8.0.1
  intl_phone_field: ^3.2.0
  geolocator: ^14.0.1
  flutter_typeahead: ^5.2.0


dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_launcher_icons: ^0.14.3


flutter_launcher_icons:
  android: "launcher_icon"
  ios: true
  image_path: "assets/images/drive_ai5.png"
  min_sdk_android: 21


  # The "flutter_lints" package below contains a set of recommended lints to
  # encourage good coding practices. The lint set provided by the package is
  # activated in the `analysis_options.yaml` file located at the root of your
  # package. See that file for information about deactivating specific lint
  # rules and activating additional ones.
  flutter_lints: ^5.0.0


# For information on the generic Dart part of this file, see the
# following page: https://dart.dev/tools/pub/pubspec


# The following section is specific to Flutter packages.
flutter:


  generate: true


  # The following line ensures that the Material Icons font is
  # included with your application, so that you can use the icons in
  # the material Icons class.
  uses-material-design: true


  # To add assets to your application, add an assets section, like this:
  assets:
   
    - assets/animations/
    - assets/data/
    - assets/icons/
    - assets/images/
    - assets/images/drive_ai5.png


  # An image asset can refer to one or more resolution-specific "variants", see
  # https://flutter.dev/to/resolution-aware-images


  # For details regarding adding assets from package dependencies, see
  # https://flutter.dev/to/asset-from-package


  # To add custom fonts to your application, add a fonts section here,
  # in this "flutter" section. Each entry in this list should have a
  # "family" key with the font family name, and a "fonts" key with a
  # list giving the asset and other descriptors for the font. For
  # example:
  # fonts:
  #   - family: Schyler
  #     fonts:
  #       - asset: fonts/Schyler-Regular.ttf
  #       - asset: fonts/Schyler-Italic.ttf
  #         style: italic
  #   - family: Trajan Pro
  #     fonts:
  #       - asset: fonts/TrajanPro.ttf
  #       - asset: fonts/TrajanPro_Bold.ttf
  #         weight: 700
  #
  # For details regarding fonts from package dependencies,
  # see https://flutter.dev/to/font-from-package